<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Maporys</title>
    <!-- FAVICON - Site İkonu -->
    <link rel="icon" type="image/jpeg" href="https://raw.githubusercontent.com/simit4sameti-prog/gezi/2dc829678a678bedabc4c8bce4330d8a94c5bea5/65dc1944-b4bd-479c-950a-57336cc7abf1.jpg">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#0f172a',
                            card: '#1e293b',
                            text: '#f8fafc'
                        },
                        brand: {
                            500: '#ef4444', 
                            600: '#dc2626'
                        }
                    },
                    animation: {
                        'fadeIn': 'fadeIn 0.3s ease-out forwards',
                        'bounce-short': 'likeBounce 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)'
                    }
                }
            }
        }
    </script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase Compat SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        /* GLOBAL RESET & FIXES */
        html, body, #root { 
            width: 100%; 
            height: 100%; 
            margin: 0; 
            padding: 0; 
            overflow: hidden; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            touch-action: none; 
        }

        /* Performans için donanım hızlandırma */
        .leaflet-container { 
            width: 100%; 
            height: 100%; 
            z-index: 1; 
            background: #f8fafc; 
            touch-action: none; 
            transform: translate3d(0,0,0);
        }
        .leaflet-interactive { cursor: pointer !important; }

        .dark .leaflet-tile-pane { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); }
        .dark .leaflet-container { background: #1a202c; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes likeBounce { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
        .like-anim { animation: likeBounce 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        /* City Labels on Map */
        .city-label {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0,0,0,0.1); 
            border-radius: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            font-size: 11px; font-weight: 700; color: #334155;
            padding: 2px 8px;
            text-align: center; opacity: 1 !important; white-space: nowrap;
            pointer-events: none;
            transition: all 0.3s;
            transform: translate3d(0,0,0);
            will-change: transform;
        }
        .dark .city-label { 
            background: rgba(15, 23, 42, 0.9); 
            border-color: rgba(255,255,255,0.1);
            color: #e2e8f0; 
        }
        
        .city-label-progress {
            font-size: 9px; color: #ef4444; font-weight: 800; display: block; margin-top: -2px;
        }
        .dark .city-label-progress { color: #f87171; }
        
        .leaflet-tooltip { background: transparent; border: none; box-shadow: none; pointer-events: none; }
        .leaflet-tooltip-top:before, .leaflet-tooltip-bottom:before, .leaflet-tooltip-left:before, .leaflet-tooltip-right:before { display: none; }

        /* Marker Images on Map */
        .city-marker-img {
            width: 48px !important; 
            height: 48px !important; 
            border-radius: 50%; 
            object-fit: cover;
            border: 3px solid white; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
            transition: transform 0.2s;
            background-color: white;
            pointer-events: none; 
        }
        .city-marker-img:hover { transform: scale(1.2); z-index: 1000; }
        .dark .city-marker-img { border-color: #334155; }

        /* Custom Util Classes */
        .custom-scrollbar { scrollbar-width: thin; }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden transition-colors duration-300 font-sans">
    <div id="root" class="h-full w-full overflow-hidden"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ==========================================
        // --- AYARLAR & YAPILANDIRMA ---
        // ==========================================
        
        const LOGO_URL = "https://raw.githubusercontent.com/simit4sameti-prog/gezi/2dc829678a678bedabc4c8bce4330d8a94c5bea5/65dc1944-b4bd-479c-950a-57336cc7abf1.jpg";

        const link = document.querySelector("link[rel*='icon']") || document.createElement('link');
        link.type = 'image/jpeg';
        link.rel = 'icon';
        link.href = LOGO_URL;
        document.getElementsByTagName('head')[0].appendChild(link);

        const MANUAL_GEMINI_KEY = ""; 

        const MANUAL_FIREBASE_CONFIG = {
          apiKey: "AIzaSyBB5WR_SqJOjcKJjMLElGnwclYYbX_6zNQ",
          authDomain: "adimadim-5b4da.firebaseapp.com",
          projectId: "adimadim-5b4da",
          storageBucket: "adimadim-5b4da.firebasestorage.app",
          messagingSenderId: "751539260206",
          appId: "1:751539260206:web:a9278d0953627121b088bf",
          measurementId: "G-EY96KQHCSZ"
        };

        const envApiKey = typeof apiKey !== 'undefined' ? apiKey : ""; 
        const finalApiKey = (envApiKey && envApiKey.length > 5) ? envApiKey : MANUAL_GEMINI_KEY;
        
        const firebaseConfig = MANUAL_FIREBASE_CONFIG || (typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let app, auth, db;
        let isFirebaseReady = false;

        if (typeof firebase !== 'undefined' && firebaseConfig) {
            try {
                if (!firebase.apps.length) {
                    app = firebase.initializeApp(firebaseConfig);
                } else {
                    app = firebase.app();
                }
                auth = firebase.auth();
                db = firebase.firestore();
                isFirebaseReady = true;
            } catch (e) {
                console.error("Firebase başlatma hatası:", e);
            }
        }

        // ==========================================
        // --- YARDIMCI BİLEŞENLER & FONKSİYONLAR ---
        // ==========================================

        const Icon = ({ name, className, onClick }) => {
            const ref = useRef(null);
            useEffect(() => {
                if(window.lucide && ref.current) {
                    const pascalName = name.split('-').map(n => n.charAt(0).toUpperCase() + n.slice(1)).join('');
                    const iconNode = window.lucide.icons[pascalName];
                    if(iconNode) {
                        const svg = window.lucide.createElement(iconNode);
                        if(className) {
                            const existingClass = svg.getAttribute('class') || '';
                            svg.setAttribute('class', `${existingClass} ${className}`.trim());
                        }
                        ref.current.innerHTML = '';
                        ref.current.appendChild(svg);
                    }
                }
            }, [name, className]);
            return <span ref={ref} onClick={onClick} className={`inline-flex items-center justify-center ${onClick ? 'cursor-pointer' : ''}`}></span>;
        };

        const StarRating = ({ rating, setRating, readOnly = false, size = "w-5 h-5" }) => {
            return (
                <div className="flex gap-1">
                    {[1, 2, 3, 4, 5].map((star) => (
                        <button
                            key={star}
                            onClick={() => !readOnly && setRating(star)}
                            className={`${readOnly ? 'cursor-default' : 'cursor-pointer hover:scale-110 transition-transform'}`}
                            disabled={readOnly}
                        >
                            <Icon 
                                name="star" 
                                className={`${size} ${star <= rating ? 'text-yellow-400 fill-yellow-400' : 'text-gray-300 dark:text-gray-600'}`} 
                            />
                        </button>
                    ))}
                </div>
            );
        };

        const callGeminiAPI = async (prompt) => {
            if (!finalApiKey) return "Hata: API anahtarı eksik.";
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${finalApiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) throw new Error('API Hatası');
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "Yanıt alınamadı.";
            } catch (error) { return "Yapay zeka servisine ulaşılamıyor."; }
        };

        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                // Büyük dosyalarda bellek sorununu önlemek için createObjectURL kullanıyoruz
                const url = URL.createObjectURL(file);
                const img = new Image();
                img.onload = () => {
                    URL.revokeObjectURL(url);
                    const canvas = document.createElement('canvas');
                    // Hafıza ve Firestore limiti için 500px yeterli
                    const MAX_DIMENSION = 500; 
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height) { 
                        if (width > MAX_DIMENSION) { height *= MAX_DIMENSION / width; width = MAX_DIMENSION; } 
                    } else { 
                        if (height > MAX_DIMENSION) { width *= MAX_DIMENSION / height; height = MAX_DIMENSION; } 
                    }
                    
                    canvas.width = width; 
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Kalite 0.4
                    resolve(canvas.toDataURL('image/jpeg', 0.4));
                };
                img.onerror = (e) => {
                    URL.revokeObjectURL(url);
                    reject(e);
                };
                img.src = url;
            });
        };

        const formatTimeAgo = (isoDate) => {
            if (!isoDate) return "Bilinmiyor";
            const now = new Date();
            const date = new Date(isoDate);
            const diffInSeconds = Math.floor((now - date) / 1000);
            if (diffInSeconds < 120) return "Çevrimiçi";
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} dk önce aktifti`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} sa önce aktifti`;
            return `${Math.floor(diffInSeconds / 86400)} gün önce aktifti`;
        };

        // --- Şehir ve Kategori Bazlı Öneriler ---
        const citySuggestionsData = {
            "Adana": { "Genel": ["Taş Köprü", "Sabancı Merkez Camii", "Büyük Saat", "Kazancılar Çarşısı"], "Yemek": ["Adana Kebap ", "Şalgam Suyu", "Bici Bici", "Şırdan"], "Doğa": ["Seyhan Baraj Gölü", "Kapıkaya Kanyonu", "Belemedik", "Karataş Tabiat Parkı "], "Eğlence": ["Playland", "GoKart Yarış Pisti", "Kano", "Optimum"], "Tarih": ["Anavarza Antik Kenti", "Varda Köprüsü", "Yılankale", "Ramazanoğlu Konağı"] },
            "Adıyaman": { "Genel": ["Nemrut Dağı", "Cendere Köprüsü", "Karakuş Tümülüsü", "Adıyaman Müzesi"], "Yemek": ["Adıyaman Çiğ Köfte", "Besni Tavası", "Tırşik", "Meyir Çorbası"], "Doğa": ["Gölbaşı Gölleri", "Sugözü", "Gümüşkaya Mağaraları", "Atatürk Barajı Seyir Terası"],"Eğlence": ["Park AVM", "Adıyaman Çarşısı", "Atatürk Bulvarı", "Pirin Seyir Tepesi"],"Tarih": ["Perre Antik Kenti", "Arsameia", "Eski Kahta Kalesi", "Sofraz Tümülüsleri"] },
            "Afyon": { "Genel": ["Afyon Kalesi", "Mevlevihane Müzesi", "Zafer Müzesi", "Tarihi Konaklar"], "Yemek": ["Afyon Sucuğu", "Kaymaklı Ekmek Kadayıfı", "Bükme", "Ağzı Açık"], "Doğa": ["Frig Vadisi", "Akdağ Tabiat Parkı", "Eber Gölü", "26 Ağustos Tabiat Parkı"],"Eğlence": ["Park Afyon AVM", "Erenler", "Afium", "Masal Dünyası Parkı"], "Tarih": ["Karahisar Kalesi", "Ayazini Metropolisi", "Ulu Camii", "İhsaniye Döğer Kervansarayı"] },
            "Ağrı": { "Genel": ["İshak Paşa Sarayı", "Ağrı Dağı", "Doğubayazıt Çarşısı", "Nuh'un Gemisi İzi"], "Yemek": ["Abdigör Köftesi", "Haşıl", "Murtuğa", "Selekeli"], "Doğa": ["Balık Gölü", "Diyadin Kaplıcaları", "Meteor Çukuru", "Eleşkirt Güneykaya Kayak Merkezi"],"Eğlence": ["Ağrı Park AVM", "Kayak Merkezi", "Ağrı Dağına Tırmanış", "Doğu Beyazıt Çarşısı"], "Tarih": ["İshak Paşa Sarayı", "Ahmed-i Hani Türbesi", "Urartu Kalesi", "Meya Mağaraları"] },
            "Amasya": { "Genel": ["Kral Kaya Mezarları", "Yalıboyu Evleri", "Amasya Kalesi", "Amasya Arkeoloji Müzesi"], "Yemek": ["Amasya Çöreği", "Bakla Dolması", "Toyga Çorbası", "Keşkek"], "Doğa": ["Boraboy Gölü", "Yedi Kuğular Kuş Cenneti", "Yeşilırmak Kıyısı", "Yedikır Barajı"],"Eğlence": ["Amasya Park AVM", "Yalıboyu", "Mustafa Kemal Paşa Caddesi", "Kano"], "Tarih": ["Hazeranlar Konağı", "Ferhat ile Şirin Müzesi", "Bimarhane", "Burmalı Minare Cami"] },
            "Ankara": { "Genel": ["Anıtkabir", "Ankara Kalesi", "Atakule", "Kocatepe Camii"], "Yemek": ["Ankara Döneri", "Ankara Tavası", "Beypazarı Kurusu", "Ankara Simidi"], "Doğa": ["Eymir Gölü", "Soğuksu Milli Parkı", "Mogan Gölü", "Seğmenler Parkı"],"Eğlence": ["Kızılay", "Ankamall", "Atatürk Orman Çifliği", "Lunapark"], "Tarih": ["Anadolu Medeniyetleri Müzesi", "Augustus Tapınağı", "İlk Meclis", "Roma Hamamı"] },
            "Antalya": { "Genel": ["Kaleiçi", "Düden Şelalesi", "Konyaaltı Plajı", "Antalya Müzesi"], "Yemek": ["Piyaz", "Serpme Börek", "Yanık Dondurma", "Hibeş"], "Doğa": ["Köprülü Kanyon", "Kurşunlu Şelalesi", "Tazı Kanyonu", "Manavgat Şelalesi"],"Eğlence": ["The Land of Legends", "Mark Antalya", "Konyaaltı Sahili", "Kaleiçi"],  "Deniz": ["Kaputaş Plajı", "Patara", "Çıralı", "Lara Plajı"], "Tarih": ["Aspendos", "Perge", "Termessos", "Olympos"] },
            "Artvin": { "Genel": ["Atatepe", "Mençuna Şelalesi", "Cam Teras", "Çifte Köprü"], "Yemek": ["Laz Böreği", "Mıhlama", "Cağ Kebabı", "Hamsili Ekmek"], "Doğa": ["Karagöl (Borçka)", "Karagöl (Şavşat)", "Cehennem Deresi Kanyonu", "Macahel(camili)"],"Eğlence": ["Çoruh Nehri Rafting", "Hatila Vadisi Cam Teras", "İnönü Caddesi", "Artrium AVM"], "Tarih": ["Artvin Kalesi", "İshak Paşa Sarayı", "Dolishane Kilisesi", "Tibeti Kilisesi"] },
            "Aydın": { "Genel": ["Güvercinada", "Forum Aydın", "Kent Meydanı", "Nasuh Paşa Külliyesi"], "Yemek": ["Aydın Pidesi", "Çine Köftesi", "Paşa Böreği", "Keşkek"], "Doğa": ["Bafa Gölü", "Dilek Yarımadası", "Zeus Mağarası", "Arapapıştı Kanyonu"],"Eğlence": ["Adnan Menderes Bulvarı", "Forum Aydın AVM", "Dilek Yarımadaması Parkı", "Kuşadası Çarşı"],  "Tarih": ["Afrodisias", "Milet Antik Kenti", "Didyma Apollon Tapınağı", "Tralleis"], "Deniz": ["Altınkum", "Kadınlar Denizi", "Dilek Yarımadası", "Davutlar Sahili"] },
            "Balıkesir": { "Genel": ["Saat Kulesi", "Zağnos Paşa Camii", "Cunda Adası", "Kuvayi Milliye Müzesi"], "Yemek": ["Höşmerim", "Susurluk Tostu", "Balıkesir Kaymaklısı", "Tirit"], "Doğa": ["Kaz Dağları", "Manyas Kuş Cenneti", "Hasanboğuldu", "Değirmen Boğazı"], "Eğlence": ["10 Burda AVM", "Milli Kuvvetler Caddesi", "Nef", "ONON"], "Deniz": ["Sarımsaklı Plajı", "Akçay", "Altınoluk", "Erdek"],"Tarih": ["Antandros", "Kyzikos", "Taksiyarhis Kilisesi", "Zağnos Paşa Türbesi"] },
            "Bilecik": { "Genel": ["Şeyh Edebali Türbesi", "Saat Kulesi", "Pelitözü Göleti", "Söğüt Ertuğrul Gazi Müzesi"], "Yemek": ["Bıldırcın Kebabı", "Nohutlu Mantı", "Bozada", "Bilecik Güveci"], "Doğa": ["Harmankaya Kanyonu", "Kınık Şelalesi", "Çömlekçiköy", "Küçükelmalı Tabiat Parkı"],"Eğlence": ["Pelitoğlu city AVM", "Bilecik Merkez Çarşı", "Osmaneli", "Üniversite Çevresi"],  "Tarih": ["Ertuğrul Gazi Türbesi", "Metristepe Anıtı", "Dursun Fakih Türbesi", "Orhan Gazi Camii"] },
            "Bingöl": { "Genel": ["Yüzen Adalar", "Bingöl Üniversitesi", "Kale Tepesi", "Kültür Parkı"], "Yemek": ["Gömme", "Löl", "Mastuva", "Sorina Pel"], "Doğa": ["Çır Şelalesi", "Kral Kızı Kalesi", "Sülbüs Dağı", "Yolçatı Kayak Merkezi"],"Eğlence": ["Galeria AVM", "Miliamall AVM", "Genç Caddesi", "Çarşı Merkezi"], "Tarih": ["Zağ Mağaraları", "Kral Kızı Kalesi", "Kiğı Kalesi", "Sentarius Kalesi"] },
            "Bitlis": { "Genel": ["Bitlis Kalesi", "İhlasiye Medresesi", "Beş Minare", "Ahlat Müzesi"], "Yemek": ["Büryan Kebabı", "Bitlis Köftesi", "Avşor", "Ciğer Taplaması"], "Doğa": ["Nemrut Krater Gölü", "Süphan Dağı", "Van Gölü Sahili", "Aygır Gölü"],"Eğlence": ["Bitlis Kayak Merkezi", "Tatvan Merkez", "Bitlis Merkez Çarşı", "Tatvan Yaşam AVM"], "Tarih": ["Ahlat Selçuklu Mezarlığı", "El-Aman Hanı", "Bitlis Ulu Camii", "İslahiye Medresesi"] },
            "Bolu": { "Genel": ["Gölcük Tabiat Parkı", "Yedigöller", "Abant Gölü", "Bolu Müzesi"], "Yemek": ["Bolu Mantısı", "Kızılcık Tarhanası", "Kabaklı Gözleme", "Kedi Batmaz"], "Doğa": ["Yedigöller Milli Parkı", "Abant", "Sülüklü Göl", "Gölcük"],"Eğlence": ["14 Burda AVM", "Kartalkaya Kayak Merkezi", "İzzel Baysal Caddesi", "Üniversite Çevresi"], "Tarih": ["Seben Kaya Evleri", "Yıldırım Bayezid Camii", "Zafer Kulesi", "Mudurnu Evleri"] },
            "Burdur": { "Genel": ["Salda Gölü", "Burdur Müzesi", "Saat Kulesi", "Doğa Tarihi Müzesi"], "Yemek": ["Burdur Şiş", "Ceviz Ezmesi", "Haşhaş Helvası", "Burdur Muhallebisi"], "Doğa": ["Salda Gölü", "İnsuyu Mağarası", "Karanlık Dere Kanyonu", "Karacaören Barajı"],"Eğlence": ["Merkez Çarşı", "Üniversite Çevresi", "Yeraltı Çarşısı", "Çıkış Tabelası"], "Tarih": ["Sagalassos", "Kibyra", "Hacılar Höyüğü", "Kremna Antik Kenti"] },
            "Bursa": { "Genel": ["Ulu Camii", "Yeşil Türbe", "Koza Han", "Tophane Saat Kulesi"], "Yemek": ["İskender Kebap", "Pideli Köfte", "Kestane Şekeri", "Cantık"], "Doğa": ["Uludağ", "Suuçtu Şelalesi", "Gölyazı", "Saitabat Şelalesi"],"Eğlence": ["Korupark AVM", "Soğanlı Botanik Park", "Extrempark", "FSM Bulvarı"], "Tarih": ["Cumalıkızık", "Bursa Kalesi", "Muradiye Külliyesi", "Emir Sultan Camii"] },
            "Çanakkale": { "Genel": ["Truva Atı", "Aynalı Çarşı", "Kordon", "Çanakkale Şehitler Abidesi"], "Yemek": ["Ezine Peyniri", "Peynir Helvası", "Sardalya", "Melki Yemeği"], "Doğa": ["Kaz Dağları", "Bozcaada", "Gökçeada", "Kazdağı Milli Parkı"],"Eğlence": ["17 Burda AVM", "Kordonboyu", "Barlar Sokağı", "Dalış"], "Tarih": ["Gelibolu Yarımadası", "Truva Antik Kenti", "Assos", "Kilitbahir Kalesi"], "Deniz": ["Ayazma Plajı", "Kadırga Koyu", "Güzelyalı", "Dardanos"] },
            "Çankırı": { "Genel": ["Tuz Mağarası", "Çankırı Kalesi", "Taş Mescit", "Buğday Pazarı Medresesi"], "Yemek": ["Yumurta Tatlısi", "Sarımsaklı Et", "Çankırı Pidesi", "Tutmaç Çorbası"], "Doğa": ["Kadınçayırı", "Kırkpınar Yaylası", "Alpsarı Göleti", "Ilgaz Dağı Milli Parkı"],"Eğlence": ["Merkez Çarşı", "Üniversite Çevresi", "Yunus AVM", "Ilgaz Kayak Merkezi"], "Tarih": ["Çankırı Kalesi", "Taş Mescit", "Sultan Süleyman Camii", "Çankırı Müzesi"] },
            "Çorum": { "Genel": ["Saat Kulesi", "Çorum Müzesi", "İncesu Kanyonu", "Katipler Konağı"], "Yemek": ["Çorum Leblebisi", "İskilip Dolması", "Çatal Aşı", "Sırık Kebabı"], "Doğa": ["Hattuşaş", "Alacahöyük", "İncesu Kanyonu", "Çatak Tabiat Parkı"],"Eğlence": ["AHL Park AVM", "Çorum Lunaparkı", "Gazi / İnönü Caddesi", "Üniversite Çevresi"], "Tarih": ["Hattuşaş (Hitit Başkenti)", "Alacahöyük", "Yazılıkaya", "Şapinuva"] },
            "Denizli": { "Genel": ["Pamukkale Travertenleri", "Çınar Meydanı", "Teleferik", "Bayramyeri Meydanı"], "Yemek": ["Denizli Kebabı", "Zafer Gazozu", "Tavas Baklavası", "Çaput Aşı"], "Doğa": ["Pamukkale", "Keloğlan Mağarası", "Güney Şelalesi", "Honaz Dağı"],"Eğlence": ["Forum Çamlık AVM", "Denizli Hayvanat Bahçesi", "Bayram Yeri", "Çamlık/Forum Çevrsi"], "Tarih": ["Hierapolis", "Laodikeia", "Tripolis", "Akhan Kervansarayı"] },
            "Diyarbakır": { "Genel": ["Diyarbakır Surları", "Ulu Camii", "Hasan Paşa Hanı", "Cahit Sıtkı Tarancı Müzesi"], "Yemek": ["Ciğer Kebabı", "Meftune", "Burma Kadayıf", "Duvaklı Pilav"], "Doğa": ["Hevsel Bahçeleri", "Dicle Nehri", "Birkleyn Mağaraları", "Çermik Kaplıcaları"],"Eğlence": ["Kayapınar", "Suriçi", "Diyarbakır Hayvanat Bahçesi", "Forum Diyarbakır AVM"], "Tarih": ["Diyarbakır Surları", "On Gözlü Köprü", "Zerzevan Kalesi", "Malabadi Köprüsü"] },
            "Edirne": { "Genel": ["Selimiye Camii", "Meriç Köprüsü", "Karaağaç", "Edirne Arkeoloji Müzesi"], "Yemek": ["Tava Ciğer", "Edirne Peyniri", "Badem Ezmesi", "Mamzana"], "Doğa": ["Gala Gölü", "İbrice Limanı", "Saros Körfezi", "Söğütlük Kent Ormanı"],"Eğlence": ["Saraçlar Caddesi", "Karaağaç", "Erasta Edirme AVM", "Meriç Nehri Çevresi"], "Tarih": ["Selimiye Camii", "Rüstem Paşa Kervansarayı", "Adalet Kasrı", "Eski Camii"] },
            "Elazığ": { "Genel": ["Harput Kalesi", "Kapalı Çarşı", "Kültür Park", "Keban Barajı"], "Yemek": ["Gakgoş Döner", "Harput Köfte", "Orcik", "Peynirli Ekmek"], "Doğa": ["Hazar Gölü", "Buzluk Mağarası", "Çırçır Şelalesi", "Golan Kaplıcaları"],"Eğlence": ["Park 23 AVM", "Üniversite Mahallesi", "Gazi Caddesi", "Elazığ Lunaparkı"], "Tarih": ["Harput Kalesi", "Ulu Camii", "Meryem Ana Kilisesi", "Palu Kalesi"] },
            "Erzincan": { "Genel": ["Ergan Dağı", "Saat Kulesi", "Bakırcılar Çarşısı", "Erzincan Müzesi"], "Yemek": ["Erzincan Döneri", "Kesme Çorbası", "Tulum Peyniri", "Kelecoş"], "Doğa": ["Girlevik Şelalesi", "Karanlık Kanyon", "Ekşisu", "Otlukbeli Gölü"],"Eğlence": ["Erzincan Piazza AVM", "Kordonboyu", "Ergan Kayam Merkezi", "Atatürk Caddesi"], "Tarih": ["Altıntepe Ören Yeri", "Mama Hatun Türbesi", "Terzibaba Türbesi", "Kemah Kalesi"] },
            "Erzurum": { "Genel": ["Çifte Minareli Medrese", "Palandöken", "Üç Kümbetler", "Erzurum Kongre Binası"], "Yemek": ["Cağ Kebabı", "Kadayıf Dolması", "Ayran Aşı", "Su Böreği"], "Doğa": ["Tortum Şelalesi", "Narman Peribacaları", "Yedi Göller", "Çoruh Vadisi"],"Eğlence": ["Cumhuriyet Caddesi", "Erzurum Piazza AVM", "Palandöken Kayak Merkezi", "Erzurum Forum AVM"], "Tarih": ["Erzurum Kalesi", "Yakutiye Medresesi", "Çobandede Köprüsü", "Rüstem Paşa Kervansarayı"] },
            "Eskişehir": { "Genel": ["Porsuk Çayı", "Sazova Parkı", "Odunpazarı Evleri", "Devrim Arabaları Müzesi"], "Yemek": ["Çibörek", "Balaban Kebabı", "Met Helvası", "Haşhaşlı Çörek"], "Doğa": ["Musaözü Tabiat Parkı", "Şelale Park", "Kentpark", "Kanlıkavak Parkı"], "Eğlence": ["Barlar Sokağı", "Collesium", "Cassaba Modern", "Kanlıkavak"], "Tarih": ["Odunpazarı", "Kurşunlu Külliyesi", "Midas Anıtı (Yazılıkaya)", "Tülomsaş Müzesi"] },
            "Gaziantep": { "Genel": ["Zeugma Müzesi", "Bakırcılar Çarşısı", "Gaziantep Kalesi", "Emine Göğüş Mutfak Müzesi"], "Yemek": ["Baklava", "Beyran", "Katmer", "Ali Nazik"], "Doğa": ["Dülükbaba Ormanı", "Rumkale", "Alleben Göleti", "Burç Ormanları"],"Eğlence": ["Gaziantep Hayvanat Bahçesi", "Lunapark", "Uzay Gemisi Eğlence Merkezi", "İbrahimli/Batıkent/Osmangazi Çevresi"], "Tarih": ["Zeugma", "Tarihi Gümrük Hanı", "Zincirli Bedesten", "Bayazhan"] },
            "Giresun": { "Genel": ["Giresun Adası", "Giresun Kalesi", "Zeytinlik", "Giresun Müzesi"], "Yemek": ["Giresun Pidesi", "Karalahana Çorbası", "Fındık Ezmesi", "Hamsi Böreği"], "Doğa": ["Kümbet Yaylası", "Kuzalan Şelalesi", "Mavi Göl", "Paşakonağı Yaylası"],"Eğlence": ["Giresun Hayvanat Bahçesi", "Lunapark", "Gazi Caddesi", "Masal Çocuk Eğlence Merkezi"], "Tarih": ["Giresun Kalesi", "Gogora Kilisesi", "Seyyid Vakkas Türbesi", "Tirebolu Kalesi"] },
            "Gümüşhane": { "Genel": ["Karaca Mağarası", "Tomara Şelalesi", "Zigana", "Gümüşhane Konakları"], "Yemek": ["Gümüşhane Kömesi", "Siron", "Kuşburnu Suyu", "Katıklı Çorba"], "Doğa": ["Örümcek Ormanları", "Limni Gölü", "Artabel Gölleri", "Kadırga Yaylası"],"Eğlence": ["Metropol AVM", "Atatürk Caddesi", "Çocuk Eğlence Merkezi", "Sema Doğan Parkı"], "Tarih": ["Santa Harabeleri", "Kov Kalesi", "Süleymaniye Mahallesi", "İmera Manastırı"] },
            "Hakkari": { "Genel": ["Meydan Medresesi", "Zap Suyu", "Şemdinli", "Hakkari Kilimi Atölyeleri"], "Yemek": ["Doğaba", "Kepaye", "Parmak Kebabı", "Çukurca Tahini"], "Doğa": ["Cilo Dağları", "Sat Gölleri", "Berçelan Yaylası", "Merga Bütan Kayak Merkezi"],"Eğlence": ["Kayak Merkezi", "Valilik Parkı", "Bulvar Caddesi", "Cilo ve Sat Dağları Milli Parkı"], "Tarih": ["Hakkari Kalesi", "Taş Köprü", "Kayme Sarayı", "Mir Kalesi"] },
            "Hatay": { "Genel": ["Habib-i Neccar Camii", "Uzun Çarşı", "Harbiye Şelaleleri", "Eski Antakya Evleri"], "Yemek": ["Künefe", "Tepsi Kebabı", "Humus", "Kağıt Kebabı"], "Doğa": ["Titus Tüneli", "Musa Ağacı", "Çevlik Plajı", "Batıayaz Yaylası"],"Eğlence": ["Park Forbes AVM", "Primemall İskenderun", "Lunapark", "İskenderun Sahil Kordonu"], "Tarih": ["Saint Pierre Kilisesi", "Hatay Arkeoloji Müzesi", "Vespasianus Tüneli", "St. Simeon Manastırı"] },
            "Isparta": { "Genel": ["Gül Bahçeleri", "Eğirdir Gölü", "Davraz", "Süleyman Demirel Demokrasi Müzesi"], "Yemek": ["Isparta Kebabı", "Gül Reçeli", "Yalvaç Güllacı", "Bakla Borani"], "Doğa": ["Yazılı Kanyon", "Lavanta Köyü", "Kovada Gölü", "Kızıldağ Milli Parkı"],"Eğlence": ["Kafeler Caddesi", "Iyaş Park AVM", "Kirazlıdere Seyir Terası", "Hayvanat Bahçesi"], "Tarih": ["Adada Antik Kenti", "Antiocheia", "Dündar Bey Medresesi", "Men Tapınağı"] },
            "Mersin": { "Genel": ["Kızkalesi", "Cennet Cehennem", "Mersin Marina", "Mersin Deniz Müzesi"], "Yemek": ["Tantuni", "Cezerye", "Kerebiç", "Batırık"], "Doğa": ["Yerköprü Şelalesi", "Astım Mağarası", "Tarsus Şelalesi", "Cennet Cehennem Mağaraları"],"Eğlence": ["Tarsus Doğa Parkı", "Kushimoto Sokağı", "Mersin Sahil Lunapark", "Sayapark AVM"], "Tarih": ["Uzuncaburç", "Mamure Kalesi", "Kanlıdivane", "Soli Pompeipolis"], "Deniz": ["Susanoğlu", "Yapraklı Koy", "Boğsak", "Tisan Yarımadası"] },
            "İstanbul": { "Genel": ["Galata Kulesi", "Ayasofya", "İstiklal Caddesi", "Kız Kulesi"], "Yemek": ["Sultanahmet Köftesi", "Balık Ekmek", "Vefa Bozacısı", "Ortaköy Kumpiri"], "Doğa": ["Belgrad Ormanı", "Emirgan Korusu", "Polonezköy", "Atatürk Arboretumu"], "Tarih": ["Topkapı Sarayı", "Yerebatan Sarnıcı", "Dolmabahçe Sarayı", "Süleymaniye Camii"], "Eğlence": ["Forum İstanbul", "Moi Park", "İstanbul Akvaryum", "Legoland Discovery Centre"] },
            "İzmir": { "Genel": ["Saat Kulesi", "Kordon", "Kemeraltı", "İzmir Doğal Yaşam Parkı"], "Yemek": ["Boyoz", "İzmir Kumru", "İzmir Köfte", "Şambali"], "Doğa": ["İnciraltı Kent Ormanı", "Karagöl", "Homeros Vadisi", "Sasalı Doğal Yaşam Parkı"], "Deniz": ["Çeşme Ilıca", "Alaçatı", "Urla", "Foça"], "Tarih": ["Efes Antik Kenti", "Agora", "Kadifekale", "Bergama Antik Kenti"], "Eğlence": ["Alsancak Kıbrıs Şehitleri", "Alaçatı Sokakları", "Bostanlı", "Kordon Boyu"] },
            "K. Maraş": { "Genel": ["Kahramanmaraş Kalesi", "Tarihi Kapalı Çarşı", "Yedi Güzel Adam Edebiyat Müzesi", "Maraş Müzesi"], "Yemek": ["Maraş Dondurması", "Eli Böğründe", "Acem Pilavı", "Maraş Tarhanası"], "Doğa": ["Başkonuş Yaylası", "Yedikuyular Kayak Merkezi", "Fırnız Mesire Alanı", "Tekir Yaylası"],"Eğlence": ["Kahramanmaraş Hayvanat Bahçesi", "Piazza AVM", "Yedikuyular Kayak Merkezi", "Kılavuzlu Parkı"], "Tarih": ["Eshab-ı Kehf Külliyesi", "Taş Köprü (Ceyhan)", "Hurman Kalesi", "Ulu Camii"] },
            "Kars": { "Genel": ["Kars Kalesi", "Taş Köprü", "Fethiye Camii", "Kars Peynir Müzesi"], "Yemek": ["Kars Kazı", "Kaşar Peyniri", "Hangel", "Evelik Çorbası"], "Doğa": ["Çıldır Gölü", "Sarıkamış", "Kuyucuk Gölü", "Kars Çayı"],"Eğlence": ["Sarıkamış Kayak Merkezi", "Atatürk Caddesi", "Faikbey Caddesi", "Karsaş"], "Tarih": ["Ani Harabeleri", "Havariler Kilisesi", "Kars Tabyaları", "Fethiye Cami"] },
            "Kastamonu": { "Genel": ["Kastamonu Kalesi", "Saat Kulesi", "Nasrullah Meydanı", "Kastamonu Saat Kulesi"], "Yemek": ["Etli Ekmek", "Banduma", "Çekme Helva", "Simit Tiridi"], "Doğa": ["Valla Kanyonu", "Ilıca Şelalesi", "Küre Dağları", "Ilgaz Dağı"],"Eğlence": ["Kastamall AVM", "Santra Park", "Nasrullah Meydanı", "Kuzeykent Gençlik Merkezi Çevresi"], "Tarih": ["Mahmut Bey Camii", "İsmail Bey Külliyesi", "Pompeipolis", "Yılanlı Külliyesi"] },
            "Kayseri": { "Genel": ["Erciyes Dağı", "Cumhuriyet Meydanı", "Kayseri Kalesi", "Kayseri Lisesi Milli Mücadele Müzesi"], "Yemek": ["Kayseri Mantısı", "Pastırma", "Yağlama", "Nevzine Tatlısı"], "Doğa": ["Kapuzbaşı Şelaleleri", "Sultan Sazlığı", "Hacer Ormanları", "Ali Dağı"],"Eğlence": ["Hayvanat Bahçesi", "Lunapark", "Forum Kayseri", "Erciyes Kayak Merkezi"], "Tarih": ["Kültepe", "Hunat Hatun Külliyesi", "Gevher Nesibe Müzesi", "Ağırnas Yer Altı Şehri"] },
            "Kırklareli": { "Genel": ["İğneada", "Dupnisa Mağarası", "Kıyıköy", "Atatürk Evi"], "Yemek": ["Kırklareli Köftesi", "Hardaliye", "Oğlak Kebabı", "Papara"], "Doğa": ["Longoz Ormanları", "Balkaya", "Cehennem Şelaleleri", "İğneada Longoz Ormanları Milli Parkı"],"Eğlence": ["39 Burda AVM", "Lunapark", "İstasyon Caddesi", "Yayla Mahallesi"], "Tarih": ["Vize Kalesi", "Küçük Ayasofya", "Hızırbey Camii", "Sokollu Mehmet Paşa Külliyesi"] },
            "Kırşehir": { "Genel": ["Cacabey Medresesi", "Ahi Evran Külliyesi", "Kent Park", "Kırşehir Müzesi"], "Yemek": ["Ahi Pilavı", "Kırşehir Köftesi", "Pekmezli Pelte", "Çömlekte Kuru Fasulye"], "Doğa": ["Seyfe Gölü", "Hirfanlı Barajı", "Japon Bahçesi", "Aşıkpaşa Tabiat Parkı"], "Tarih": ["Kalehöyük", "Mucur Yeraltı Şehri", "Aşık Paşa Türbesi", "Cacabey Gökbilim Medresesi"] },
            "Kocaeli": { "Genel": ["Maşukiye", "Kartepe", "Sekapark", "Gayret Gemi Müzesi"], "Yemek": ["Pişmaniye", "Mancar Yemeği", "Cızlama", "Değirmendere Fındığı"], "Doğa": ["Ormanya", "Ballıkayalar", "Yuvacık Barajı", "Kefken Pembe Kayalar"],"Eğlence": ["41 Burda AVM", "Hayvanat Bahçesi", "Tes Ev", "Seka Park"], "Tarih": ["Hannibal Mezarı", "Kasr-ı Hümayun", "Saat Kulesi", "Eskihisar Kalesi"] },
            "Konya": { "Genel": ["Mevlana Müzesi", "Alaaddin Tepesi", "Tropikal Kelebek Bahçesi", "Sille Köyü"], "Yemek": ["Etli Ekmek", "Fırın Kebabı", "Bamya Çorbası", "Tirit"], "Doğa": ["Tuz Gölü", "Beyşehir Gölü", "Meke Krater Gölü", "Meram Bağları"],"Eğlence": ["Kent Plaza AVM", "Hayvanat Bahçesi", "Kelebek Vadisi", "Bosna Hersek Mahallesi"], "Tarih": ["Çatalhöyük", "İnce Minareli Medrese", "Karatay Medresesi", "Nasreddin Hoca Türbesi"] },
            "Kütahya": { "Genel": ["Kütahya Kalesi", "Çinili Camii", "Germiyan Sokağı", "Kütahya Çini Müzesi"], "Yemek": ["Cimcik", "Sini Mantısı", "Kütahya Köftesi", "Tirit"], "Doğa": ["Domaniç Ormanları", "Murat Dağı", "Frig Vadisi", "Çamlıca Tabiat Parkı"], "Tarih": ["Aizanoi Antik Kenti", "Dönenler Camii", "Kütahya Arkeoloji Müzesi", "Kütahya Kalesi"] },
            "Malatya": { "Genel": ["Şire Pazarı", "Sanat Sokağı", "Battalgazi", "Malatya Müzesi"], "Yemek": ["Kayısı", "Kağıt Kebabı", "Analı Kızlı", "Kiraz Yaprağı Köftesi"], "Doğa": ["Günpınar Şelalesi", "Levent Vadisi", "Tohma Kanyonu", "Orduzu Pınarbaşı"], "Tarih": ["Arslantepe Höyüğü", "Eski Malatya Surları", "Ulu Camii", "Battalgazi Ulu Camii"] },
            "Manisa": { "Genel": ["Spil Dağı", "Mesir Macunu Festivali", "Kula Evleri", "Manisa Müzesi"], "Yemek": ["Manisa Kebabı", "Mesir Macunu", "Kula Güveci", "Sultaniye Üzümü"], "Doğa": ["Kula Peribacaları", "Ağlayan Kaya", "Kurşunlu Kaplıcaları", "Spil Dağı Milli Parkı"], "Tarih": ["Sardes Antik Kenti", "Muradiye Camii", "Aigai", "Ağlayan Kaya (Niobe)"] },
            "Mardin": { "Genel": ["Mardin Evleri", "Deyrulzafaran Manastırı", "Ulu Camii", "Mardin Müzesi"], "Yemek": ["Kaburga Dolması", "Sembusek", "Mırra", "İkbebet"], "Doğa": ["Beyazsu", "Gurs Vadisi", "Zinnar Bağları", "Mardin Ovası Manzarası"], "Tarih": ["Dara Antik Kenti", "Kasımiye Medresesi", "Zinciriye Medresesi", "Kırklar Kilisesi"] },
            "Muğla": { "Genel": ["Bodrum Kalesi", "Ölüdeniz", "Kelebekler Vadisi", "Muğla Müzesi"], "Yemek": ["Çökertme Kebabı", "Kabak Çiçeği Dolması", "Muğla Köftesi", "Muğla Saraylısı"], "Doğa": ["Saklıkent Kanyonu", "Dalyan", "Azmak Nehri", "Yuvarlakçay"], "Deniz": ["İztuzu Plajı", "Akyaka", "Datça Palamutbükü", "Sarıgerme Plajı"], "Tarih": ["Kaunos", "Knidos", "Kayaköy", "Tlos Antik Kenti"] },
            "Muş": { "Genel": ["Muş Kalesi", "Tarihi Murat Köprüsü", "Yıldız Alparslan Tarım İşletmesi", "Muş Lalesi Alanları"], "Yemek": ["Muş Köftesi", "Hez Dolması", "Çorti Aşı", "Muş Böreği"], "Doğa": ["Hamurpet Gölü", "Varto", "Murat Nehri", "Varto Kayalıdere"], "Tarih": ["Arak Manastırı", "Hasbet Kalesi", "Ulu Camii", "Muş Ulu Camii"] },
            "Nevşehir": { "Genel": ["Kapadokya", "Göreme Açık Hava Müzesi", "Uçhisar Kalesi", "Hacı Bektaş Veli Türbesi"], "Yemek": ["Testi Kebabı", "Nevşehir Tavası", "Kabak Çekirdeği", "Aside Tatlısı"], "Doğa": ["Ihlara Vadisi", "Kızılçukur Vadisi", "Aşk Vadisi", "Güvercinlik Vadisi"], "Tarih": ["Derinkuyu Yeraltı Şehri", "Kaymaklı Yeraltı Şehri", "Paşabağları", "Zelve Ören Yeri"] },
            "Niğde": { "Genel": ["Niğde Kalesi", "Saat Kulesi", "Gümüşler Manastırı", "Niğde Müzesi"], "Yemek": ["Niğde Tavası", "Söğürme", "Elma", "Mazakeri"], "Doğa": ["Aladağlar", "Çiniligöl", "Narlıgöl", "Kayardı Bağları"], "Tarih": ["Tyana Antik Kenti", "Roma Havuzu", "Alaaddin Camii", "Hüdavent Hatun Türbesi"] },
            "Ordu": { "Genel": ["Boztepe", "Yason Burnu", "Taşbaşı Mahallesi", "Ordu Teleferik"], "Yemek": ["Ordu Tostu", "Pancar Çorbası", "Fındık", "Galdirik Kavurması"], "Doğa": ["Çambaşı Yaylası", "Perşembe Yaylası", "Ulugöl", "Çiseli Şelalesi"], "Tarih": ["Kurul Kalesi", "Paşaoğlu Konağı", "Bolaman Kalesi", "Yason Kilisesi"] },
            "Rize": { "Genel": ["Ayder Yaylası", "Zilkale", "Rize Kalesi", "Rize Müzesi"], "Yemek": ["Muhlama", "Laz Böreği", "Rize Simidi", "Hamsili Pilav"], "Doğa": ["Fırtına Deresi", "Pokut Yaylası", "Gito Yaylası", "Anzer Yaylası"], "Tarih": ["Zilkale", "Şenyuva Köprüsü", "Atatürk Evi", "Kız Kalesi"] },
            "Sakarya": { "Genel": ["Sapanca Gölü", "Karasu", "Serdivan Gölpark", "Deprem Müzesi"], "Yemek": ["Islama Köfte", "Kabak Tatlısı", "Çerkez Tavuğu", "Pekmezli Ayva Tatlısı"], "Doğa": ["Acarlar Longozu", "Poyrazlar Gölü", "Maden Deresi", "Kuzuluk Kaplıcaları"], "Tarih": ["Justinianus Köprüsü", "Harmantepe Kalesi", "Rüstem Paşa Camii", "Beşköprü"] },
            "Samsun": { "Genel": ["Bandırma Vapuru", "Atatürk Anıtı", "Amisos Tepesi", "Samsun Kent Müzesi"], "Yemek": ["Samsun Pidesi", "Nokul", "Tirit", "Bafra Pidesi"], "Doğa": ["Şahinkaya Kanyonu", "Kızılırmak Deltası", "Ayvacık", "Ladik Gölü"], "Tarih": ["Gazi Müzesi", "Amazon Köyü", "Tekkeköy Mağaraları", "Dündartepe Höyüğü"] },
            "Siirt": { "Genel": ["Tillo", "Deliklitaş", "Saat Kulesi", "Siirt Battaniyesi Atölyeleri"], "Yemek": ["Büryan", "Perde Pilavı", "Siirt Fıstığı", "Kitelli"], "Doğa": ["Botan Vadisi", "Rasıl Hacar", "Veysel Karani", "Botan Çayı"], "Tarih": ["Ulu Camii", "İsmail Fakirullah Türbesi", "Derzin Kalesi", "Veysel Karani Türbesi"] },
            "Sinop": { "Genel": ["Tarihi Cezaevi", "Hamsilos Koyu", "İnceburun", "Sinop Arkeoloji Müzesi"], "Yemek": ["Sinop Mantısı", "Nokul", "Palamut", "Mısır Çorbası"], "Doğa": ["Erfelek Şelaleleri", "Akgöl", "Sarıkum", "Tatlıca Şelaleleri"], "Tarih": ["Sinop Kalesi", "Paşa Tabyaları", "Alaaddin Camii", "Balatlar Kilisesi"] },
            "Sivas": { "Genel": ["Çifte Minareli Medrese", "Buruciye Medresesi", "Kongre Müzesi", "Sivas Arkeoloji Müzesi"], "Yemek": ["Sivas Köftesi", "Peskutan Çorbası", "Katmer", "Madımak"], "Doğa": ["Gökpınar Gölü", "Sızır Şelalesi", "Eğriçimen Yaylası", "Tödürge Gölü"], "Tarih": ["Divriği Ulu Camii", "Gök Medrese", "Şifaiye Medresesi", "Buruciye Medresesi"] },
            "Şanlıurfa": { "Genel": ["Balıklıgöl", "Göbeklitepe", "Sıra Gecesi", "Şanlıurfa Müzesi"], "Yemek": ["Urfa Kebap", "Çiğ Köfte", "Şıllık Tatlısı", "Bostana"], "Doğa": ["Halfeti", "Takoran Vadisi", "Atatürk Barajı", "Tek Tek Dağları Milli Parkı"], "Tarih": ["Göbeklitepe", "Harran Evleri", "Rizvaniye Camii", "Şuayb Antik Kenti"] },
            "Şırnak": { "Genel": ["Cizre Kırmızı Medrese", "Mem u Zin Türbesi", "Nuh Tufanı Gemisi", "Şırnak Kent Meydanı"], "Yemek": ["Perdepilav", "Kipe", "Hekeheşandi", "Meyre"], "Doğa": ["Cudi Dağı", "Kasrik Boğazı", "Faraşin Yaylası", "Cehennem Deresi"], "Tarih": ["Cizre Surları", "Finik Ören Yeri", "Abdaliye Medresesi", "Meryem Ana Kilisesi"] },
            "Tekirdağ": { "Genel": ["Rakoczi Müzesi", "Sahil", "Rüstem Paşa Camii", "Tekirdağ Arkeoloji ve Etnografya Müzesi"], "Yemek": ["Tekirdağ Köftesi", "Peynir Helvası", "Hayrabolu Tatlısı", "Satır Et"], "Doğa": ["Uçmakdere", "Kumbağ", "Ganos Dağları", "Çamlıköy Tabiat Parkı"], "Tarih": ["Namık Kemal Evi", "Hora Feneri", "Perinthos Antik Kenti", "Rüstem Paşa Külliyesi"] },
            "Tokat": { "Genel": ["Tokat Kalesi", "Taşhan", "Saat Kulesi", "Tokat Müzesi"], "Yemek": ["Tokat Kebabı", "Bat", "Zile Pekmezi", "Tokat Çemeni"], "Doğa": ["Ballıca Mağarası", "Kaz Gölü", "Zinav Gölü", "Topçam Yaylası"], "Tarih": ["Mahperi Hatun Kervansarayı", "Ali Paşa Camii", "Gök Medrese", "Hıdırlık Köprüsü"] },
            "Trabzon": { "Genel": ["Sümela Manastırı", "Uzungöl", "Atatürk Köşkü", "Trabzon Şehir Müzesi"], "Yemek": ["Akçaabat Köftesi", "Kuymak", "Hamsiköy Sütlacı", "Karalahana Sarması"], "Doğa": ["Uzungöl", "Sera Gölü", "Çal Mağarası", "Altındere Vadisi"], "Tarih": ["Ayasofya Camii", "Bedesten", "Gülbahar Hatun Camii", "Vazelon Manastırı"] },
            "Tunceli": { "Genel": ["Munzur Vadisi", "Ovacık", "Pertek Kalesi", "Tunceli Müzesi"], "Yemek": ["Dersim Kömbeti", "Babuko", "Şir", "Zerefet"], "Doğa": ["Munzur Gözeleri", "Pülümür Vadisi", "Kutu Deresi", "Munzur Vadisi Milli Parkı"], "Tarih": ["Pertek Kalesi", "Rabat Kalesi", "Ergen Kilisesi", "Çemişgezek Kalesi"] },
            "Uşak": { "Genel": ["Uşak Arkeoloji Müzesi", "Ulubey Kanyonu", "Atapark", "Uşak Halı Müzesi"], "Yemek": ["Tarhana Çorbası", "Çömlek Kebabı", "Demir Tatlısı", "Uşak Katmeri"], "Doğa": ["Ulubey Kanyonu", "Taşyaran Vadisi", "Clandras Köprüsü", "Banaz Çayı"], "Tarih": ["Blaundus Antik Kenti", "Burma Camii", "Pepouza", "Uşak Bedesteni"] },
            "Van": { "Genel": ["Van Kalesi", "Akdamar Adası", "Van Kedisi Evi", "Van Urartu Müzesi"], "Yemek": ["Van Kahvaltısı", "Otlu Peynir", "İnci Kefali", "Kavut"], "Doğa": ["Van Gölü", "Muradiye Şelalesi", "Kanispi Şelalesi", "Erçek Gölü"], "Tarih": ["Hoşap Kalesi", "Akdamar Kilisesi", "Çavuştepe", "Van Kalesi"] },
            "Yozgat": { "Genel": ["Çamlık Milli Parkı", "Saat Kulesi", "Yozgat Müzesi", "Yozgat Şehir Parkı"], "Yemek": ["Testi Kebabı", "Arabaşı", "Parmak Çörek", "Yozgat Böreği"], "Doğa": ["Kazankaya Kanyonu", "Akdağmadeni Ormanları", "Bozok Yaylası", "Yozgat Fatih Tabiat Parkı"], "Tarih": ["Basilica Therma", "Büyüknefes", "Çapanoğlu Camii", "Sarıkaya Roma Hamamı"] },
            "Zonguldak": { "Genel": ["Maden Müzesi", "Fener Mahallesi", "Liman", "Zonguldak Maden Müzesi"], "Yemek": ["Osmanlı Çileği", "Uğmaç Çorbası", "Malay", "Zonguldak Simidi"], "Doğa": ["Gökgöl Mağarası", "Harmankaya Şelaleleri", "Filyos", "Çayır Köyü Su Mağarası"], "Tarih": ["Filyos Antik Kenti", "Halil Paşa Konağı", "Varagel Tüneli", "Filyos Kalesi"] },
            "Aksaray": { "Genel": ["Ihlara Vadisi", "Eğri Minare", "Somuncu Baba", "Aksaray Meydanı"], "Yemek": ["Aksaray Tava", "Sıkma", "Şerbetli Pide", "Mantarlı Bulgur Pilavı"], "Doğa": ["Ihlara Vadisi", "Hasan Dağı", "Tuz Gölü", "Narlıgöl"], "Tarih": ["Sultanhanı", "Aşıklı Höyük", "Yılanlı Kilise", "Ağzıkarahan Kervansarayı"] },
            "Bayburt": { "Genel": ["Bayburt Kalesi", "Saat Kulesi", "Baksı Müzesi", "Şehit Osman Tepesi"], "Yemek": ["Bayburt Döneri", "Lor Dolması", "Tel Helva", "Galacoş"], "Doğa": ["Çimağil Mağarası", "Sırakayalar Şelalesi", "Kop Dağı", "Yakapınar Şelalesi"], "Tarih": ["Bayburt Kalesi", "Dede Korkut Türbesi", "Aydıntepe Yeraltı Şehri", "Bayburt Saat Kulesi"] },
            "Karaman": { "Genel": ["Karaman Kalesi", "Aktekke Camii", "Hatuniye Medresesi", "Karaman Müzesi"], "Yemek": ["Arabaşı", "Batırık", "Calla", "Karaman Kebabı"], "Doğa": ["Manazan Mağaraları", "Gökçeseki", "Ermenek Barajı", "Ermenek Turkuaz Baraj Gölü"], "Tarih": ["Binbirkilise", "Derbe", "Taşkale Tahıl Ambarları", "Yunus Emre Camii"] },
            "Kırıkkale": { "Genel": ["Silah Müzesi", "Celal Bayar Parkı", "MKE Sanayi", "Kırıkkale Kent Ormanı"], "Yemek": ["Kırıkkale Tavası", "Sızgıt", "Un Tarhanası", "Keskin Tava"], "Doğa": ["Karaahmetli Tabiat Parkı", "Oba Köy", "Çeşnigir Kanyonu", "Celal Bayar Parkı"], "Tarih": ["Çeşnigir Köprüsü", "Hasandede Camii", "Sulu Mağara", "Çeşnigir Köprüsü"] },
            "Batman": { "Genel": ["Hasankeyf", "Malabadi Köprüsü", "Petrol Kent", "Batman Müzesi"], "Yemek": ["Batman Usulü Kütülk", "Şam Börek", "Mumbar", "Tandır Ekmeği"], "Doğa": ["Hasankeyf Mağaraları", "Sason", "Mereto Dağı", "Kıra Dağı"], "Tarih": ["Hasankeyf Kalesi", "Mor Kiryakus Manastırı", "Zeynel Bey Türbesi", "Memikan Köprüsü"] },
            "Bartın": { "Genel": ["Amasra", "Çekiciler Çarşısı", "Kuşkayası Anıtı", "Bartın Kent Müzesi"], "Yemek": ["Amasra Salatası", "Bartın Mantısı", "Pumpum Çorbası", "Bartın Tatlısı"], "Doğa": ["Güzelcehisar Lav Sütunları", "İnkumu", "Gölderesi Şelalesi", "Gürcüoluk Mağarası"], "Tarih": ["Amasra Kalesi", "Kemere Köprüsü", "Fatih Camii", "Güzelcehisar Kalesi"] },
            "Ardahan": { "Genel": ["Ardahan Kalesi", "Şeytan Kalesi", "Kura Nehri", "Ardahan Şehitliği"], "Yemek": ["Ardahan Balı", "Kaz Eti", "Hıngel", "Feselli"], "Doğa": ["Çıldır Gölü", "Yalnızçam Yaylası", "Bülbülan Yaylası", "Aktaş Gölü"], "Tarih": ["Şeytan Kalesi", "Akçakale Adası", "Kinzi Kalesi", "Ardahan Merkez Camii"] },
            "Iğdır": { "Genel": ["Ağrı Dağı Manzarası", "Soykırım Anıtı", "Tuzluca", "Iğdır Soykırım Anıtı"], "Yemek": ["Bozbaş", "Taş Köfte", "Kaysafa", "Omaç Helvası"], "Doğa": ["Aras Nehri", "Gökkuşağı Tepeleri", "Tuz Mağaraları", "Pamuk Dağı"], "Tarih": ["Harmandöven Kervansarayı", "Karakale Harabeleri", "Koçbaşı Mezarlar", "Ejder Kervansarayı"] },
            "Yalova": { "Genel": ["Yürüyen Köşk", "Termal", "Sahil", "Yalova Kent Müzesi"], "Yemek": ["Yalova Sütlüsü", "Pavli", "Termal Çorbası", "Yalova Köftesi"], "Doğa": ["Sudüşen Şelalesi", "Delmece Yaylası", "Erikli Yaylası", "Hasanbaba Mesire Yeri"], "Tarih": ["Yürüyen Köşk", "Kara Kilise", "Çoban Kale", "Taşköprü"] },
            "Karabük": { "Genel": ["Safranbolu Evleri", "Kristal Teras", "Hıdırlık Tepesi", "Karabük Demir Çelik Müzesi"], "Yemek": ["Bükme", "Peruhi", "Safranlı Lokum", "Mısır Çorbası"], "Doğa": ["Tokatlı Kanyonu", "Bulak Mencilis Mağarası", "Yenice Ormanları", "Eğriova Göleti"], "Tarih": ["Cinci Hanı", "Kaymakamlar Gezi Evi", "Yörük Köyü", "Hadrianapolis Antik Kenti"] },
            "Kilis": { "Genel": ["Ravanda Kalesi", "Cumhuriyet Meydanı", "Oylum Höyük", "Kilis Müzesi"], "Yemek": ["Kilis Tava", "Oruk", "Şıhılmahşe", "Kilis Katmeri"], "Doğa": ["Hisar Çamlığı", "Akpınar", "Söğütlüdere", "Resul Osman Dağı"], "Tarih": ["Ulu Camii", "Neşet Efendi Konağı", "Mozaikli Bazilika", "Şeyh Mansur Türbesi"] },
            "Osmaniye": { "Genel": ["Toprakkale Kalesi", "Karatepe Aslantaş", "Kent Müzesi", "Osmaniye Masal Park"], "Yemek": ["Osmaniye Yer Fıstığı", "Tırşik", "Zorkun Tavası", "Osmaniye Kömbesi"], "Doğa": ["Zorkun Yaylası", "Karaçay Şelalesi", "Kastabala", "Karatepe Aslantaş Milli Parkı"], "Tarih": ["Karatepe Açık Hava Müzesi", "Kastabala Antik Kenti", "Harun Reşit Kalesi", "Toprakkale Kalesi"] },
            "Düzce": { "Genel": ["Konuralp Müzesi", "Güzeldere Şelalesi", "Akçakoca", "Düzce 15 Temmuz Parkı"], "Yemek": ["Düzce Köftesi", "Mamursa", "Akçakoca Melengücceği", "Düzce Mantısı"], "Doğa": ["Samandere Şelalesi", "Aydınpınar Şelalesi", "Fakıllı Mağarası", "Efteni Gölü"], "Tarih": ["Prusias ad Hypium", "Ceneviz Kalesi", "Hemşin Camii", "Konuralp Antik Tiyatrosu"] }
        };

        const customCityCenters = {
            'Antalya': [36.95, 30.70], 'Muğla': [37.20, 28.45], 'İstanbul': [41.05, 28.97],
            'Çanakkale': [40.15, 26.40], 'İzmir': [38.42, 27.14], 'Balıkesir': [39.65, 27.88],
            'Bursa': [40.18, 29.06], 'Mersin': [36.80, 34.63], 'Samsun': [41.28, 36.33],
            'Trabzon': [40.95, 39.75], 'Rize': [40.95, 40.85], 'Artvin': [41.18, 41.82],
            'Hakkari': [37.57, 43.73], 'Kocaeli': [40.85, 29.88], 'Tekirdağ': [40.98, 27.51],
            'Zonguldak': [41.35, 31.79], 'Sinop': [41.95, 35.10]
        };

        const getRank = (count) => {
            if (count >= 50) return { title: "Dünya Vatandaşı", icon: "globe", color: "text-indigo-600" };
            if (count >= 30) return { title: "Evliya Çelebi", icon: "compass", color: "text-purple-600" };
            if (count >= 20) return { title: "Kâşif", icon: "map", color: "text-blue-600" };
            if (count >= 10) return { title: "Gezgin", icon: "backpack", color: "text-green-600" };
            return { title: "Çırak", icon: "footprints", color: "text-gray-500" };
        };

        const filterProfanity = (text) => {
            if (!text) return "";
            const BAD_WORDS = ["aptal", "salak", "gerizekalı", "mal", "öküz", "dangalak", "ahmak", "manyak", "pislik", "şerefsiz", "küfür"];
            let cleanText = text;
            BAD_WORDS.forEach(word => { const regex = new RegExp(word, "gi"); cleanText = cleanText.replace(regex, "*".repeat(word.length)); });
            return cleanText;
        };

        // --- CINEMA MODAL ---
        const CinemaModal = ({ markers, onClose }) => {
            const [currentIndex, setCurrentIndex] = useState(0);
            const visualMarkers = markers.filter(m => m.images && m.images.length > 0);

            if (visualMarkers.length === 0) return (
                <div className="fixed inset-0 z-[1600] bg-black flex items-center justify-center text-white flex-col p-6 animate-fadeIn">
                    <Icon name="film" className="w-16 h-16 mb-4 opacity-50 text-gray-500"/>
                    <h2 className="text-xl font-bold">Henüz hiç fotoğraf yok.</h2>
                    <p className="text-gray-400 text-sm mt-2 text-center">Haritaya anı ve fotoğraf ekleyerek kendi sinemanı oluştur.</p>
                    <button onClick={onClose} className="mt-8 px-8 py-2 bg-gray-800 rounded-full hover:bg-gray-700 transition-colors">Kapat</button>
                </div>
            );

            const current = visualMarkers[currentIndex];
            const cover = current.favoriteImage || current.images[0];
            
            const next = () => setCurrentIndex((prev) => (prev + 1) % visualMarkers.length);
            const prev = () => setCurrentIndex((prev) => (prev - 1 + visualMarkers.length) % visualMarkers.length);

            return (
                <div className="fixed inset-0 z-[1600] bg-black flex items-center justify-center animate-fadeIn">
                    <button onClick={onClose} className="absolute top-4 right-4 z-50 p-2 bg-black/50 rounded-full text-white hover:bg-white/20 transition-colors"><Icon name="x" className="w-8 h-8"/></button>
                    <div className="relative w-full h-full md:w-[450px] md:h-[90%] bg-gray-900 md:rounded-2xl overflow-hidden shadow-2xl flex flex-col">
                        <div className="flex-1 relative group">
                             <img src={cover} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" />
                             <div className="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent"></div>
                             <div className="absolute bottom-0 left-0 w-full p-8 text-white">
                                <div className="flex items-center gap-2 mb-2">
                                    <Icon name="map-pin" className="w-5 h-5 text-red-500 fill-current"/>
                                    <span className="font-bold text-2xl tracking-tight">{current.cityName}</span>
                                    <span className="text-xs bg-white/20 px-2 py-0.5 rounded ml-2 font-medium">@{current.username || "ben"}</span>
                                </div>
                                <div className="text-sm text-gray-300 mb-4 font-mono">{current.date}</div>
                                {current.note && <p className="text-base text-gray-200 italic line-clamp-4 leading-relaxed border-l-2 border-red-500 pl-3">"{current.note}"</p>}
                                <div className="flex gap-1.5 mt-6 justify-center">
                                    {visualMarkers.map((_, idx) => (
                                        <div key={idx} className={`h-1 rounded-full transition-all duration-300 ${idx === currentIndex ? 'w-6 bg-red-500' : 'w-1.5 bg-white/30'}`}></div>
                                    ))}
                                </div>
                             </div>
                        </div>
                        <button onClick={prev} className="absolute left-2 top-1/2 -translate-y-1/2 p-3 text-white/50 hover:text-white rounded-full"><Icon name="chevron-left" className="w-10 h-10"/></button>
                        <button onClick={next} className="absolute right-2 top-1/2 -translate-y-1/2 p-3 text-white/50 hover:text-white rounded-full"><Icon name="chevron-right" className="w-10 h-10"/></button>
                    </div>
                </div>
            );
        };

        // --- LEADERBOARD MODAL ---
        const LeaderboardModal = ({ appId, myUsername, friends, onClose }) => {
            const [users, setUsers] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const fetchLeaderboard = async () => {
                    const allUsers = [myUsername, ...friends];
                    const data = [];
                    
                    for (const username of allUsers) {
                        try {
                            const mapDoc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_maps').doc(username).get();
                            const profileDoc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_profiles').doc(username).get();
                            
                            let visited = 0;
                            if (mapDoc.exists) {
                                const markers = mapDoc.data().markers || [];
                                visited = markers.filter(m => m.status !== 'bucket').length;
                            }
                            
                            const avatar = profileDoc.exists ? profileDoc.data().avatar : null;
                            data.push({ username, visited, avatar });
                        } catch (e) {
                            console.error(e);
                        }
                    }
                    
                    data.sort((a, b) => b.visited - a.visited);
                    setUsers(data);
                    setLoading(false);
                };
                fetchLeaderboard();
            }, [appId, myUsername, friends]);

            return (
                <div className="fixed inset-0 z-[1500] bg-black bg-opacity-70 flex items-center justify-center p-4 animate-fadeIn">
                    <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-sm p-6 relative overflow-hidden flex flex-col max-h-[80vh]">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><Icon name="x" className="w-5 h-5"/></button>
                        <h2 className="text-2xl font-bold text-gray-800 dark:text-white mb-4 text-center flex items-center justify-center gap-2"><Icon name="trophy" className="w-6 h-6 text-yellow-500"/> Lider Tablosu</h2>
                        
                        {loading ? (
                             <div className="flex-1 flex items-center justify-center"><div className="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div></div>
                        ) : (
                            <div className="flex-1 overflow-y-auto custom-scrollbar space-y-2">
                                {users.map((u, i) => (
                                    <div key={u.username} className={`flex items-center justify-between p-3 rounded-xl border ${u.username === myUsername ? 'bg-indigo-50 border-indigo-200 dark:bg-indigo-900/30 dark:border-indigo-800' : 'bg-gray-50 border-gray-100 dark:bg-gray-700/50 dark:border-gray-600'}`}>
                                            <div className="flex items-center gap-3">
                                                <div className={`font-black text-lg w-6 text-center ${i===0 ? 'text-yellow-500' : i===1 ? 'text-gray-400' : i===2 ? 'text-amber-600' : 'text-gray-400 opacity-50'}`}>{i+1}</div>
                                                <div className="w-10 h-10 rounded-full bg-gray-200 overflow-hidden flex items-center justify-center text-xs font-bold text-gray-500">
                                                    {u.avatar ? <img src={u.avatar} className="w-full h-full object-cover"/> : u.username.substring(0,2).toUpperCase()}
                                                </div>
                                                <div className="flex flex-col">
                                                    <span className={`text-sm font-bold ${u.username === myUsername ? 'text-indigo-700 dark:text-indigo-300' : 'text-gray-700 dark:text-gray-200'}`}>@{u.username}</span>
                                                    <span className="text-[10px] text-gray-400">{getRank(u.visited).title}</span>
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <div className="text-xl font-black text-gray-800 dark:text-white">{u.visited}</div>
                                                <div className="text-[9px] uppercase font-bold text-gray-400">Şehir</div>
                                            </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- STATS MODAL ---
        const StatsModal = ({ markers, onClose }) => {
            const visitedCount = markers.filter(m => m.status !== 'bucket').length;
            const bucketCount = markers.filter(m => m.status === 'bucket').length;
            const progress = Math.round((visitedCount / 81) * 100);
            
            return (
                <div className="fixed inset-0 z-[1500] bg-black bg-opacity-70 flex items-center justify-center p-4 animate-fadeIn">
                    <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-sm p-6 relative overflow-hidden">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><Icon name="x" className="w-5 h-5"/></button>
                        <h2 className="text-2xl font-bold text-gray-800 dark:text-white mb-6 text-center">İstatistikler</h2>
                        <div className="grid grid-cols-2 gap-4 mb-6">
                            <div className="bg-blue-50 dark:bg-gray-700/50 p-4 rounded-xl text-center">
                                <div className="text-3xl font-black text-blue-600">{visitedCount}</div>
                                <div className="text-xs text-gray-500 font-bold uppercase mt-1">Gezilen</div>
                            </div>
                            <div className="bg-yellow-50 dark:bg-gray-700/50 p-4 rounded-xl text-center">
                                <div className="text-3xl font-black text-yellow-600">{bucketCount}</div>
                                <div className="text-xs text-gray-500 font-bold uppercase mt-1">Hedef</div>
                            </div>
                        </div>
                        <div className="mb-6">
                            <div className="flex justify-between text-sm mb-2"><span>Türkiye Keşfi</span><span className="font-bold">%{progress}</span></div>
                            <div className="w-full bg-gray-200 dark:bg-gray-700 h-4 rounded-full overflow-hidden">
                                <div className="bg-indigo-500 h-full transition-all duration-1000" style={{width: `${progress}%`}}></div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- CHAT MODAL ---
        const ChatModal = ({ myUsername, friendUsername, onClose, sendNotif }) => {
            const [messages, setMessages] = useState([]);
            const [newMessage, setNewMessage] = useState("");
            const [pendingImage, setPendingImage] = useState(null);
            const chatId = [myUsername, friendUsername].sort().join('_');
            const scrollRef = useRef(null);

            useEffect(() => {
                const chatRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('direct_messages').doc(chatId);
                const unsub = chatRef.onSnapshot(doc => {
                    if (doc.exists) setMessages(doc.data().msgs || []);
                    else setMessages([]);
                });
                return () => unsub();
            }, [chatId]);

            useEffect(() => {
                if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
            }, [messages, pendingImage]);

            const sendMessage = async () => {
                if (!newMessage && !pendingImage) return;
                const msg = { 
                    id: Date.now(), 
                    sender: myUsername, 
                    text: newMessage, 
                    image: pendingImage || null,
                    timestamp: Date.now() 
                };
                const chatRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('direct_messages').doc(chatId);
                const doc = await chatRef.get();
                let currentMsgs = doc.exists ? doc.data().msgs : [];
                currentMsgs.push(msg);
                await chatRef.set({ msgs: currentMsgs }, { merge: true });
                await sendNotif(friendUsername, 'message', `${myUsername} sana mesaj attı.`);
                setNewMessage("");
                setPendingImage(null);
            };

            const handleImageSelect = async (e) => {
                if (e.target.files && e.target.files[0]) {
                    try {
                        const base64 = await compressImage(e.target.files[0]);
                        setPendingImage(base64);
                    } catch (err) { alert("Resim işlenemedi"); }
                }
            };

            return (
                <div className="fixed bottom-4 right-4 w-80 bg-white dark:bg-gray-800 rounded-t-2xl shadow-2xl border border-gray-200 dark:border-gray-700 z-[1400] flex flex-col h-96 animate-fadeIn">
                    <div className="bg-indigo-600 p-4 text-white rounded-t-2xl flex justify-between items-center shadow-md">
                        <div className="font-bold flex items-center gap-2"><div className="w-2 h-2 bg-green-400 rounded-full"></div> {friendUsername}</div>
                        <button onClick={onClose} className="hover:bg-white/20 p-1 rounded-full"><Icon name="x" className="w-4 h-4"/></button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-3 bg-gray-50 dark:bg-gray-900 space-y-3" ref={scrollRef}>
                        {messages.map((m, i) => (
                            <div key={i} className={`flex ${m.sender === myUsername ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[85%] rounded-2xl px-3 py-2 text-sm shadow-sm ${m.sender === myUsername ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-white border border-gray-200 text-gray-800 dark:bg-gray-700 dark:border-gray-600 dark:text-white rounded-bl-none'}`}>
                                    {m.image && <img src={m.image} className="w-full rounded-lg mb-1" />}
                                    {m.text && <div>{m.text}</div>}
                                </div>
                            </div>
                        ))}
                        {pendingImage && (
                            <div className="flex justify-end animate-fadeIn">
                                <div className="max-w-[85%] bg-indigo-50 dark:bg-indigo-900/30 border-2 border-dashed border-indigo-300 rounded-2xl p-2 relative">
                                    <button onClick={()=>setPendingImage(null)} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1"><Icon name="x" className="w-3 h-3"/></button>
                                    <img src={pendingImage} className="w-full rounded-lg opacity-80"/>
                                </div>
                            </div>
                        )}
                    </div>
                    <div className="p-2 border-t dark:border-gray-700 bg-white dark:bg-gray-800 flex gap-2 items-center">
                        <label className="cursor-pointer text-gray-500 hover:text-indigo-600 dark:text-gray-400 p-1">
                            <Icon name="image" className="w-5 h-5"/>
                            <input type="file" className="hidden" accept="image/*" onChange={handleImageSelect}/>
                        </label>
                        <input type="text" value={newMessage} onChange={(e) => setNewMessage(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && sendMessage()} className="flex-1 border dark:border-gray-600 rounded-full px-3 py-1.5 text-sm focus:outline-none focus:border-indigo-500 dark:bg-gray-700 dark:text-white" placeholder="Mesaj..."/>
                        <button onClick={sendMessage} className="text-indigo-600 hover:text-indigo-800"><Icon name="send" className="w-5 h-5"/></button>
                    </div>
                </div>
            );
        };

        // --- MESSAGES MODAL ---
        const MessagesModal = ({ myUsername, friends, onClose, onChatOpen }) => {
            const [conversations, setConversations] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const loadConversations = async () => {
                    const promises = friends.map(async (friend) => {
                        try {
                            const chatId = [myUsername, friend].sort().join('_');
                            const chatDoc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('direct_messages').doc(chatId).get();
                            
                            if (chatDoc.exists) {
                                const msgs = chatDoc.data().msgs || [];
                                if (msgs.length > 0) {
                                    const lastMsg = msgs[msgs.length - 1];
                                    const profileDoc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_profiles').doc(friend).get();
                                    const avatar = profileDoc.exists ? profileDoc.data().avatar : null;
                                    return { friend, lastMsg, avatar };
                                }
                            }
                        } catch (e) { console.error(e); }
                        return null;
                    });

                    const results = (await Promise.all(promises)).filter(Boolean);
                    results.sort((a, b) => b.lastMsg.timestamp - a.lastMsg.timestamp);
                    setConversations(results);
                    setLoading(false);
                };
                loadConversations();
            }, [myUsername, friends]);

            return (
                <div className="fixed inset-0 z-[1500] bg-black bg-opacity-70 flex items-center justify-center p-4 animate-fadeIn">
                    <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-sm p-6 relative overflow-hidden flex flex-col max-h-[80vh]">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><Icon name="x" className="w-5 h-5"/></button>
                        <h2 className="text-2xl font-bold text-gray-800 dark:text-white mb-4 text-center flex items-center justify-center gap-2"><Icon name="message-circle" className="w-6 h-6 text-indigo-500"/> Mesajlar</h2>
                        
                        {loading ? (
                             <div className="flex-1 flex items-center justify-center"><div className="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div></div>
                        ) : (
                            <div className="flex-1 overflow-y-auto custom-scrollbar space-y-2">
                                {conversations.length === 0 && <div className="text-center text-gray-400 mt-10 text-sm">Henüz mesaj yok.</div>}
                                {conversations.map((c, i) => (
                                    <div key={i} onClick={() => onChatOpen(c.friend)} className="flex items-center gap-3 p-3 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-colors border border-transparent hover:border-gray-200 dark:hover:border-gray-600">
                                        <div className="w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold text-sm overflow-hidden shrink-0">
                                             {c.avatar ? <img src={c.avatar} className="w-full h-full object-cover"/> : c.friend.substring(0,2).toUpperCase()}
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <div className="flex justify-between items-center mb-0.5">
                                                <span className="font-bold text-gray-800 dark:text-white text-sm">@{c.friend}</span>
                                                <span className="text-[10px] text-gray-400">{formatTimeAgo(new Date(c.lastMsg.timestamp).toISOString())}</span>
                                            </div>
                                            <p className="text-xs text-gray-500 dark:text-gray-400 truncate">
                                                {c.lastMsg.sender === myUsername && <span className="text-indigo-500">Sen: </span>}
                                                {c.lastMsg.image ? <span className="flex items-center gap-1"><Icon name="image" className="w-3 h-3"/> Fotoğraf</span> : c.lastMsg.text}
                                            </p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- NOTIFICATION MODAL ---
        const NotificationModal = ({ notifications, onClose, onAccept, onReject }) => {
            const [activeTab, setActiveTab] = useState("new"); // "new" | "history"

            const newNotifications = notifications.filter(n => !n.status || n.status === 'pending');
            const historyNotifications = notifications.filter(n => n.status === 'accepted' || n.status === 'rejected');

            const displayedNotifications = activeTab === "new" ? newNotifications : historyNotifications;

            return (
                <div className="fixed inset-0 z-[1300] bg-transparent flex items-start justify-end p-4 pt-16 pointer-events-none">
                    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-80 animate-fadeIn overflow-hidden pointer-events-auto border border-gray-200 dark:border-gray-700 flex flex-col max-h-[500px]">
                        <div className="bg-gray-50 dark:bg-gray-750 p-3 border-b dark:border-gray-700 flex justify-between items-center shrink-0">
                            <h3 className="font-bold text-gray-700 dark:text-white flex items-center gap-2 text-sm"><Icon name="bell" className="w-4 h-4 text-orange-500"/> Bildirimler</h3>
                            <button onClick={onClose}><Icon name="x" className="w-4 h-4 text-gray-400 hover:text-gray-600"/></button>
                        </div>
                        
                        <div className="flex border-b dark:border-gray-700 bg-gray-100 dark:bg-gray-900 shrink-0">
                            <button 
                                onClick={() => setActiveTab("new")} 
                                className={`flex-1 py-2 text-xs font-bold transition-colors ${activeTab === "new" ? "bg-white dark:bg-gray-800 text-indigo-600 border-b-2 border-indigo-600" : "text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-800"}`}
                            >
                                Yeni ({newNotifications.length})
                            </button>
                            <button 
                                onClick={() => setActiveTab("history")} 
                                className={`flex-1 py-2 text-xs font-bold transition-colors ${activeTab === "history" ? "bg-white dark:bg-gray-800 text-indigo-600 border-b-2 border-indigo-600" : "text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-800"}`}
                            >
                                Geçmiş ({historyNotifications.length})
                            </button>
                        </div>

                        <div className="overflow-y-auto p-2 bg-gray-50 dark:bg-gray-900 custom-scrollbar flex-1">
                            {displayedNotifications.length === 0 ? (
                                <p className="text-center text-sm text-gray-400 py-6 italic">
                                    {activeTab === "new" ? "Yeni bildirim yok." : "Geçmiş bildirim yok."}
                                </p>
                            ) : displayedNotifications.map((notif, idx) => (
                                <div key={idx} className={`bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-lg p-3 mb-2 shadow-sm ${notif.status === 'rejected' ? 'opacity-60' : ''}`}>
                                    <div className="flex justify-between items-start mb-2">
                                        <p className="text-sm text-gray-800 dark:text-gray-200">{notif.msg ? notif.msg : <span>@{notif.from} seni eklemek istiyor.</span>}</p>
                                        {activeTab === "history" && (
                                            <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded ${notif.status === 'accepted' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>
                                                {notif.status === 'accepted' ? 'Kabul' : 'Red'}
                                            </span>
                                        )}
                                    </div>
                                    <div className="text-[10px] text-gray-400 mb-2">{notif.date || "Tarih yok"}</div>
                                    
                                    {activeTab === "new" && (
                                        <div className="flex gap-2">
                                            <button onClick={() => onAccept(notif)} className="flex-1 bg-green-500 hover:bg-green-600 text-white text-xs py-1.5 rounded-md font-bold transition-colors">Kabul Et</button>
                                            <button onClick={() => onReject(notif)} className="flex-1 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-600 dark:text-gray-300 text-xs py-1.5 rounded-md font-bold transition-colors">Reddet</button>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- PARTNER MODAL ---
        const PartnerModal = ({ myUsername, currentPartner, onClose, onLink, onBreakUp }) => {
            const [partnerName, setPartnerName] = useState("");
            
            return (
                <div className="fixed inset-0 z-[1200] bg-black bg-opacity-70 flex items-center justify-center p-4 animate-fadeIn">
                    <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md p-6 relative overflow-hidden">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><Icon name="x" className="w-5 h-5"/></button>
                        <h2 className="text-2xl font-bold text-gray-800 dark:text-white mb-4 text-center">Sevgili Eşleşmesi</h2>
                        {!currentPartner ? (
                            <div className="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-xl border border-gray-100 dark:border-gray-600">
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Kullanıcı Adı</label>
                                <input type="text" value={partnerName} onChange={(e) => setPartnerName(e.target.value)} className="w-full border border-gray-300 dark:border-gray-500 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-pink-500 dark:bg-gray-700 dark:text-white" placeholder="Örn: aysecinar"/>
                                <button onClick={() => onLink(partnerName)} className="w-full bg-gradient-to-r from-pink-500 to-rose-500 text-white font-bold py-3 rounded-lg mt-3">Eşleşme İsteği Gönder</button>
                            </div>
                        ) : (
                            <div className="text-center bg-pink-50 dark:bg-pink-900/20 p-6 rounded-xl border border-pink-100 dark:border-pink-800">
                                <p className="text-gray-600 dark:text-gray-300 mb-6">Şu an <strong className="text-pink-600 dark:text-pink-400">@{currentPartner}</strong> ile birliktesin.</p>
                                <button onClick={onBreakUp} className="w-full bg-white text-red-600 font-bold py-3 rounded-lg border border-red-200">Ayrıl</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const SettingsModal = ({ myUsername, onClose, onLogout, darkMode, toggleDarkMode, showCityNames, setShowCityNames, onOpenStats }) => {
            const [view, setView] = useState('default');
            const [question, setQuestion] = useState("");
            const [realAnswer, setRealAnswer] = useState("");
            const [inputAnswer, setInputAnswer] = useState("");
            const [newValue, setNewValue] = useState("");
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState("");
            const [success, setSuccess] = useState("");

            useEffect(() => {
                const fetchCreds = async () => {
                    try {
                        const doc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_credentials').doc(myUsername).get();
                        if(doc.exists) {
                            setQuestion(doc.data().securityQuestion || "Güvenlik sorusu ayarlanmamış.");
                            setRealAnswer(doc.data().securityAnswer || "");
                        }
                    } catch(e) { console.error(e); }
                };
                fetchCreds();
            }, [myUsername]);

            const handlePasswordChange = async () => {
                if(!inputAnswer || !newValue) { setError("Tüm alanları doldurun."); return; }
                if(inputAnswer.toLowerCase().trim() !== realAnswer.toLowerCase().trim()) { setError("Güvenlik cevabı yanlış."); return; }
                
                setLoading(true);
                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_credentials').doc(myUsername).update({ password: newValue });
                    setSuccess("Şifre başarıyla değiştirildi.");
                    setTimeout(() => { onClose(); }, 1500);
                } catch(e) { setError("Hata oluştu."); }
                setLoading(false);
            };

            const handleUsernameChange = async () => {
                if(!inputAnswer || !newValue) { setError("Tüm alanları doldurun."); return; }
                const targetUser = newValue.toLowerCase().trim();
                if(targetUser === myUsername) { setError("Aynı kullanıcı adı."); return; }
                if(targetUser.length < 3) { setError("En az 3 karakter."); return; }
                
                if(inputAnswer.toLowerCase().trim() !== realAnswer.toLowerCase().trim()) { setError("Güvenlik cevabı yanlış."); return; }

                setLoading(true);
                try {
                    const root = db.collection('artifacts').doc(appId).collection('public').doc('data');
                    const check = await root.collection('user_credentials').doc(targetUser).get();
                    if(check.exists) { setError("Bu kullanıcı adı dolu."); setLoading(false); return; }

                    const batch = db.batch();

                    // 1. Credentials
                    const oldCreds = await root.collection('user_credentials').doc(myUsername).get();
                    batch.set(root.collection('user_credentials').doc(targetUser), { ...oldCreds.data() });
                    batch.delete(root.collection('user_credentials').doc(myUsername));

                    // 2. Profile
                    const oldProfile = await root.collection('user_profiles').doc(myUsername).get();
                    if(oldProfile.exists) batch.set(root.collection('user_profiles').doc(targetUser), oldProfile.data());
                    batch.delete(root.collection('user_profiles').doc(myUsername));

                    // 3. Map
                    const oldMap = await root.collection('user_maps').doc(myUsername).get();
                    if(oldMap.exists) batch.set(root.collection('user_maps').doc(targetUser), oldMap.data());
                    batch.delete(root.collection('user_maps').doc(myUsername));

                    // 4. Friends List
                    const oldFriends = await root.collection('user_friends').doc(myUsername).get();
                    let myFriendList = [];
                    if(oldFriends.exists) {
                        myFriendList = oldFriends.data().list || [];
                        batch.set(root.collection('user_friends').doc(targetUser), oldFriends.data());
                    }
                    batch.delete(root.collection('user_friends').doc(myUsername));

                    // 5. Notifications
                    const oldNotifs = await root.collection('user_notifications').doc(myUsername).get();
                    if(oldNotifs.exists) batch.set(root.collection('user_notifications').doc(targetUser), oldNotifs.data());
                    batch.delete(root.collection('user_notifications').doc(myUsername));

                    // 6. Partners
                    const oldPartner = await root.collection('user_partners').doc(myUsername).get();
                    if(oldPartner.exists) {
                        const pData = oldPartner.data();
                        batch.set(root.collection('user_partners').doc(targetUser), pData);
                        batch.delete(root.collection('user_partners').doc(myUsername));
                        if(pData.partner) batch.update(root.collection('user_partners').doc(pData.partner), { partner: targetUser });
                    }

                    await batch.commit();

                    // 7. Update Friends (Best Effort)
                    for (const friend of myFriendList) {
                        try {
                            const fRef = root.collection('user_friends').doc(friend);
                            const fDoc = await fRef.get();
                            if(fDoc.exists) {
                                let list = fDoc.data().list || [];
                                if(list.includes(myUsername)) {
                                    list = list.map(u => u === myUsername ? targetUser : u);
                                    await fRef.update({ list });
                                }
                            }
                        } catch(e) { console.error("Friend update error:", e); }
                    }

                    setSuccess("Kullanıcı adı değişti. Çıkış yapılıyor...");
                    setTimeout(() => { onLogout(); }, 2000);

                } catch(e) { setError("Hata: " + e.message); }
                setLoading(false);
            };

            return (
                <div className="fixed inset-0 z-[1700] bg-black/70 flex items-center justify-center p-4 animate-fadeIn backdrop-blur-sm">
                    <div className="bg-white dark:bg-gray-800 w-full max-w-sm rounded-2xl shadow-2xl p-6 border dark:border-gray-700 relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><Icon name="x" className="w-5 h-5"/></button>
                        <h2 className="text-xl font-bold mb-6 flex items-center gap-2 dark:text-white"><Icon name="settings" className="w-5 h-5 text-blue-500"/> Ayarlar</h2>
                        
                        {view === 'default' && (
                            <div className="space-y-4">
                                <div className="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg border border-gray-100 dark:border-gray-600 mb-2">
                                    <div className="flex items-center justify-between mb-3">
                                        <div className="flex items-center gap-2 text-sm font-bold text-gray-700 dark:text-white">
                                            <Icon name={darkMode ? "moon" : "sun"} className="w-4 h-4"/> 
                                            {darkMode ? "Karanlık Mod" : "Aydınlık Mod"}
                                        </div>
                                        <div 
                                            className={`w-10 h-5 rounded-full p-0.5 cursor-pointer transition-colors ${darkMode ? 'bg-indigo-500' : 'bg-gray-300'}`}
                                            onClick={toggleDarkMode}
                                        >
                                            <div className={`w-4 h-4 rounded-full bg-white shadow-sm transition-transform ${darkMode ? 'translate-x-5' : 'translate-x-0'}`}></div>
                                        </div>
                                    </div>
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-2 text-sm font-bold text-gray-700 dark:text-white">
                                            <Icon name="type" className="w-4 h-4"/> 
                                            Şehir İsimleri
                                        </div>
                                        <div 
                                            className={`w-10 h-5 rounded-full p-0.5 cursor-pointer transition-colors ${showCityNames ? 'bg-indigo-500' : 'bg-gray-300'}`}
                                            onClick={() => setShowCityNames(!showCityNames)}
                                        >
                                            <div className={`w-4 h-4 rounded-full bg-white shadow-sm transition-transform ${showCityNames ? 'translate-x-5' : 'translate-x-0'}`}></div>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Kullanıcı Adı</label>
                                    <input type="text" value={myUsername} readOnly className="w-full bg-gray-100 dark:bg-gray-900 dark:text-gray-400 border border-gray-200 dark:border-gray-700 rounded-lg p-2.5 text-sm cursor-not-allowed"/>
                                </div>
                                <button onClick={()=>setView('username')} className="w-full bg-indigo-600 text-white font-bold py-2.5 rounded-lg hover:bg-indigo-700 transition-all text-sm">Kullanıcı Adı Değiştir</button>
                                <button onClick={()=>setView('password')} className="w-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white font-bold py-2.5 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-all text-sm">Şifre Değiştir</button>
                                <button onClick={() => { onClose(); onOpenStats(); }} className="w-full bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-300 font-bold py-2.5 rounded-lg hover:bg-orange-200 dark:hover:bg-orange-800/50 transition-all text-sm flex items-center justify-center gap-2"><Icon name="bar-chart-2" className="w-4 h-4"/> İstatistikler</button>
                                <button onClick={() => { onClose(); onLogout(); }} className="w-full bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-300 font-bold py-2.5 rounded-lg hover:bg-red-200 dark:hover:bg-red-800/50 transition-all text-sm flex items-center justify-center gap-2"><Icon name="log-out" className="w-4 h-4"/> Çıkış Yap</button>
                            </div>
                        )}

                        {(view === 'username' || view === 'password') && (
                            <div className="space-y-4 animate-fadeIn">
                                <div className="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg border border-blue-100 dark:border-blue-800">
                                    <label className="block text-[10px] font-bold text-blue-600 dark:text-blue-300 uppercase mb-1">Güvenlik Sorusu</label>
                                    <p className="text-sm font-medium text-gray-800 dark:text-white">{question}</p>
                                </div>
                                
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Cevabınız</label>
                                    <input type="text" value={inputAnswer} onChange={e=>setInputAnswer(e.target.value)} className="w-full border border-gray-200 dark:border-gray-600 rounded-lg p-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"/>
                                </div>

                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">{view === 'username' ? 'Yeni Kullanıcı Adı' : 'Yeni Şifre'}</label>
                                    <input type={view === 'username' ? 'text' : 'password'} value={newValue} onChange={e=>setNewValue(e.target.value)} className="w-full border border-gray-200 dark:border-gray-600 rounded-lg p-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"/>
                                </div>

                                {error && <div className="text-red-500 text-xs font-bold">{error}</div>}
                                {success && <div className="text-green-500 text-xs font-bold">{success}</div>}

                                <div className="flex gap-2 pt-2">
                                    <button onClick={()=>{setView('default'); setError(""); setSuccess("");}} className="flex-1 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 font-bold py-2 rounded-lg text-sm">İptal</button>
                                    <button onClick={view === 'username' ? handleUsernameChange : handlePasswordChange} disabled={loading} className="flex-1 bg-blue-600 text-white font-bold py-2 rounded-lg text-sm hover:bg-blue-700 transition-all">
                                        {loading ? 'İşleniyor...' : 'Onayla'}
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- LOGIN SCREEN ---
        const LoginScreen = ({ onLogin }) => {
            const [mode, setMode] = useState("login"); // login, register, forgot
            const [username, setUsername] = useState("");
            const [password, setPassword] = useState("");
            const [securityQuestion, setSecurityQuestion] = useState("");
            const [securityAnswer, setSecurityAnswer] = useState("");
            const [error, setError] = useState("");
            const [loading, setLoading] = useState(false);
            const [success, setSuccess] = useState("");

            // Forgot Password States
            const [forgotStep, setForgotStep] = useState(1);
            const [newForgotPass, setNewForgotPass] = useState("");

            const securityQuestions = [
                "İlkokuldaki sınıf öğretmeninizin adı nedir?",
                "İlk evcil hayvanınızın adı nedir?",
                "Çocukken en sevdiğiniz oyuncağın adı nedir?",
                "İlkokula başladığınız okulun adı nedir?",
                "Annenizin kızlık soyadı nedir?",
                "En sevdiğiniz çocukluk arkadaşınızın adı nedir?",
                "İlk gittiğiniz tatil yerinin adı nedir?",
                "Çocukken en sevdiğiniz çizgi filmin adı nedir?",
                "Doğduğunuz şehir neresidir?",
                "Küçükken en çok sevdiğiniz yemeğin adı nedir?"
            ];

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError("");
                setSuccess("");
                
                if (mode === "forgot") {
                    if (forgotStep === 1) {
                        if (!username.trim() || !securityQuestion || !securityAnswer.trim()) { setError("Tüm alanları doldurun."); return; }
                        setLoading(true);
                        try {
                            const userRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_credentials').doc(username.toLowerCase());
                            const doc = await userRef.get();
                            if (!doc.exists) { setError("Bilgiler hatalı."); setLoading(false); return; }
                            
                            const data = doc.data();
                            // Check if question and answer match
                            if (data.securityQuestion !== securityQuestion || data.securityAnswer.toLowerCase().trim() !== securityAnswer.toLowerCase().trim()) {
                                setError("Güvenlik bilgileri hatalı."); setLoading(false); return;
                            }
                            
                            setForgotStep(2);
                        } catch (e) { setError("Hata oluştu."); }
                        setLoading(false);
                    } else {
                        if (!newForgotPass.trim()) { setError("Yeni şifre girin."); return; }
                        setLoading(true);
                        try {
                            const userRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_credentials').doc(username.toLowerCase());
                            await userRef.update({ password: newForgotPass });
                            setSuccess("Şifre başarıyla değiştirildi. Giriş yapabilirsiniz.");
                            setTimeout(() => { setMode("login"); setForgotStep(1); setSuccess(""); setUsername(""); setPassword(""); setSecurityQuestion(""); setSecurityAnswer(""); setNewForgotPass(""); }, 2000);
                        } catch (e) { setError("Hata oluştu."); }
                        setLoading(false);
                    }
                    return;
                }

                if (!username.trim() || !password.trim()) { setError("Kullanıcı adı ve şifre zorunludur."); return; }
                if (mode === "register" && (!securityQuestion || !securityAnswer.trim())) { setError("Güvenlik sorusu ve cevabı zorunludur."); return; }
                
                setLoading(true);
                try {
                    const userRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_credentials').doc(username.toLowerCase());
                    const doc = await userRef.get();
                    
                    if (mode === "register") {
                        if (doc.exists) { setError("Bu kullanıcı adı alınmış."); setLoading(false); return; }
                        await userRef.set({ 
                            password,
                            securityQuestion,
                            securityAnswer
                        });
                        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_profiles').doc(username.toLowerCase()).set({ lastActive: new Date().toISOString() });
                        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_friends').doc(username.toLowerCase()).set({ list: [] });
                        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_notifications').doc(username.toLowerCase()).set({ list: [] });
                        onLogin(username.toLowerCase());
                    } else {
                        if (!doc.exists || doc.data().password !== password) { setError("Kullanıcı adı veya şifre hatalı."); setLoading(false); return; }
                        onLogin(username.toLowerCase());
                    }
                } catch (err) { 
                    setError("Bir hata oluştu."); 
                    setLoading(false);
                }
            };

            return (
                <div className="flex h-screen w-full items-center justify-center bg-gray-100 dark:bg-gray-900 p-4 relative overflow-hidden">
                    <div className="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none">
                         <div className="absolute right-0 top-0 w-96 h-96 bg-red-400 rounded-full blur-3xl transform translate-x-1/2 -translate-y-1/2"></div>
                         <div className="absolute left-0 bottom-0 w-96 h-96 bg-blue-400 rounded-full blur-3xl transform -translate-x-1/2 translate-y-1/2"></div>
                    </div>

                    <div className="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-sm:px-4 max-w-sm text-center transition-all duration-300 relative z-10 border border-white/50">
                        <div className="mb-6 flex justify-center transform hover:scale-105 transition-transform duration-500">
                            <div className="bg-gradient-to-br from-red-500 to-pink-600 p-1.5 rounded-2xl shadow-lg w-28 h-28 flex items-center justify-center border-4 border-white/20 relative overflow-hidden">
                                <img src={LOGO_URL} className="w-full h-full object-cover rounded-xl bg-white" />
                            </div>
                        </div>
                        <h1 className="text-3xl font-black text-gray-800 dark:text-white mb-1 tracking-tight">Maporys</h1>
                        <p className="text-sm text-gray-500 dark:text-gray-400 mb-8 font-medium">Anılarını biriktir, rotanı paylaş.</p>
                        
                        <div className="bg-gray-100 dark:bg-gray-700 p-1 rounded-lg flex mb-6">
                            <button className={`flex-1 py-2 text-sm font-bold rounded-md transition-all ${mode === "login" ? 'bg-white dark:bg-gray-600 text-gray-800 dark:text-white shadow-sm' : 'text-gray-500 dark:text-gray-400 hover:text-gray-700'}`} onClick={() => { setMode("login"); setError(""); }}>Giriş Yap</button>
                            <button className={`flex-1 py-2 text-sm font-bold rounded-md transition-all ${mode === "register" ? 'bg-white dark:bg-gray-600 text-gray-800 dark:text-white shadow-sm' : 'text-gray-500 dark:text-gray-400 hover:text-gray-700'}`} onClick={() => { setMode("register"); setError(""); }}>Kayıt Ol</button>
                        </div>

                        {mode === "forgot" ? (
                            <form onSubmit={handleSubmit} className="space-y-4 animate-fadeIn">
                                <h3 className="text-lg font-bold text-gray-700 dark:text-white mb-2">Şifremi Unuttum</h3>
                                {forgotStep === 1 ? (
                                    <>
                                        <div className="relative">
                                            <Icon name="user" className="absolute left-3 top-3 w-5 h-5 text-gray-400"/>
                                            <input type="text" className="w-full border border-gray-200 dark:border-gray-600 rounded-lg pl-10 pr-4 py-3 text-sm focus:outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 dark:bg-gray-700 dark:text-white transition-all" placeholder="Kullanıcı Adı" value={username} onChange={e => setUsername(e.target.value)} disabled={loading} />
                                        </div>
                                        <div className="relative">
                                            <Icon name="help-circle" className="absolute left-3 top-3 w-5 h-5 text-gray-400"/>
                                            <select 
                                                className="w-full border border-gray-200 dark:border-gray-600 rounded-lg pl-10 pr-4 py-3 text-sm focus:outline-none focus:border-red-500 dark:bg-gray-700 dark:text-white appearance-none" 
                                                value={securityQuestion} 
                                                onChange={e => setSecurityQuestion(e.target.value)}
                                            >
                                                <option value="">Güvenlik Sorusu Seçin</option>
                                                {securityQuestions.map((q, i) => <option key={i} value={q}>{q}</option>)}
                                            </select>
                                        </div>
                                        <div className="relative">
                                            <Icon name="key" className="absolute left-3 top-3 w-5 h-5 text-gray-400"/>
                                            <input type="text" className="w-full border border-gray-200 dark:border-gray-600 rounded-lg pl-10 pr-4 py-3 text-sm focus:outline-none focus:border-red-500 dark:bg-gray-700 dark:text-white" placeholder="Cevabınız" value={securityAnswer} onChange={e => setSecurityAnswer(e.target.value)} />
                                        </div>
                                        <button type="submit" className="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition-all shadow-lg active:scale-95 disabled:opacity-70 disabled:cursor-not-allowed mt-2" disabled={loading}>
                                            {loading ? "Doğrulanıyor..." : "Doğrula"}
                                        </button>
                                    </>
                                ) : (
                                    <>
                                        <div className="relative">
                                            <Icon name="lock" className="absolute left-3 top-3 w-5 h-5 text-gray-400"/>
                                            <input type="password" className="w-full border border-gray-200 dark:border-gray-600 rounded-lg pl-10 pr-4 py-3 text-sm focus:outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 dark:bg-gray-700 dark:text-white transition-all" placeholder="Yeni Şifre" value={newForgotPass} onChange={e => setNewForgotPass(e.target.value)} disabled={loading} />
                                        </div>
                                        <button type="submit" className="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition-all shadow-lg active:scale-95 disabled:opacity-70 disabled:cursor-not-allowed mt-2" disabled={loading}>
                                            {loading ? "Kaydediliyor..." : "Şifreyi Yenile"}
                                        </button>
                                    </>
                                )}
                                <button type="button" onClick={() => { setMode("login"); setError(""); setSuccess(""); }} className="text-sm text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-white underline">Geri Dön</button>
                            </form>
                        ) : (
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div className="relative">
                                    <Icon name="user" className="absolute left-3 top-3 w-5 h-5 text-gray-400"/>
                                    <input type="text" className="w-full border border-gray-200 dark:border-gray-600 rounded-lg pl-10 pr-4 py-3 text-sm focus:outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 dark:bg-gray-700 dark:text-white transition-all" placeholder="Kullanıcı Adı" value={username} onChange={e => setUsername(e.target.value)} disabled={loading} />
                                </div>
                                
                                {mode === "register" && (
                                    <>
                                        <div className="relative animate-fadeIn">
                                            <Icon name="help-circle" className="absolute left-3 top-3 w-5 h-5 text-gray-400"/>
                                            <select 
                                                className="w-full border border-gray-200 dark:border-gray-600 rounded-lg pl-10 pr-4 py-3 text-sm focus:outline-none focus:border-red-500 dark:bg-gray-700 dark:text-white appearance-none" 
                                                value={securityQuestion} 
                                                onChange={e => setSecurityQuestion(e.target.value)}
                                            >
                                                <option value="">Güvenlik Sorusu Seçin</option>
                                                {securityQuestions.map((q, i) => <option key={i} value={q}>{q}</option>)}
                                            </select>
                                        </div>
                                        <div className="relative animate-fadeIn">
                                            <Icon name="key" className="absolute left-3 top-3 w-5 h-5 text-gray-400"/>
                                            <input type="text" className="w-full border border-gray-200 dark:border-gray-600 rounded-lg pl-10 pr-4 py-3 text-sm focus:outline-none focus:border-red-500 dark:bg-gray-700 dark:text-white" placeholder="Cevabınız" value={securityAnswer} onChange={e => setSecurityAnswer(e.target.value)} />
                                        </div>
                                    </>
                                )}
                                
                                <div className="relative">
                                    <Icon name="lock" className="absolute left-3 top-3 w-5 h-5 text-gray-400"/>
                                    <input type="password" className="w-full border border-gray-200 dark:border-gray-600 rounded-lg pl-10 pr-4 py-3 text-sm focus:outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 dark:bg-gray-700 dark:text-white transition-all" placeholder="Şifre" value={password} onChange={e => setPassword(e.target.value)} disabled={loading} />
                                </div>

                                {error && <div className="p-3 bg-red-50 text-red-600 text-xs rounded-lg text-left font-medium flex gap-2 items-start"><Icon name="alert-circle" className="w-4 h-4 shrink-0"/> {error}</div>}
                                {success && <div className="p-3 bg-green-50 text-green-600 text-xs rounded-lg text-left font-medium flex gap-2 items-start"><Icon name="check-circle" className="w-4 h-4 shrink-0"/> {success}</div>}
                                
                                <button type="submit" className="w-full bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700 transition-all shadow-lg hover:shadow-red-500/30 active:scale-95 disabled:opacity-70 disabled:cursor-not-allowed mt-2" disabled={loading}>
                                    {loading ? "İşleniyor..." : (mode === "register" ? "Hesap Oluştur" : "Giriş Yap")}
                                </button>
                                {mode === "login" && <button type="button" onClick={() => { setMode("forgot"); setError(""); setSuccess(""); }} className="text-xs text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-white underline mt-4 block mx-auto">Şifremi Unuttum</button>}
                            </form>
                        )}
                        <div className="mt-6 border-t border-gray-200 dark:border-gray-700 pt-4 text-center">
                            <a href="mailto:maporysofficial@gmail.com" className="text-xs font-bold text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 flex items-center justify-center gap-1 transition-colors">
                                <Icon name="mail" className="w-3 h-3"/> Bize Ulaşın
                            </a>
                        </div>
                    </div>
                </div>
            );
        };

        const MainApp = ({ myUsername, currentUsername, user, onLogout, onViewChange }) => {
            const [markers, setMarkers] = useState([]);
            const [friends, setFriends] = useState([]); 
            const [viewedFriendsList, setViewedFriendsList] = useState([]); 
            const [friendDetails, setFriendDetails] = useState({}); 
            const mapRef = useRef(null);
            const labelLayerRef = useRef(null); 
            const imageMarkersRef = useRef(null); 
            const [geoJsonLayer, setGeoJsonLayer] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false); 
            const [selectedCity, setSelectedCity] = useState(null);
            const [sidebarOpen, setSidebarOpen] = useState(window.innerWidth > 768);
            const [loading, setLoading] = useState(true);
            const [searchQuery, setSearchQuery] = useState("");
            const [hashtagSearch, setHashtagSearch] = useState(""); 
            const [viewMode, setViewMode] = useState("map"); 
            const [zoomedImage, setZoomedImage] = useState(null);
            const [userAvatar, setUserAvatar] = useState(null);
            const [currentChatFriend, setCurrentChatFriend] = useState(null);
            const [darkMode, setDarkMode] = useState(false); 
            const [isStatsOpen, setIsStatsOpen] = useState(false); 
            const [isLeaderboardOpen, setIsLeaderboardOpen] = useState(false);
            const [isCinemaOpen, setIsCinemaOpen] = useState(false); 
            const [isMessagesOpen, setIsMessagesOpen] = useState(false);
            const [showCityNames, setShowCityNames] = useState(true);

            const [activeTab, setActiveTab] = useState("personal"); 
            const [partner, setPartner] = useState(null); 
            const [isPartnerModalOpen, setIsPartnerModalOpen] = useState(false);
            const [coupleId, setCoupleId] = useState(null);

            const [notifications, setNotifications] = useState([]);
            const [isNotifOpen, setIsNotifOpen] = useState(false);
              
            const [categoryFilter, setCategoryFilter] = useState("Tümü");
              
            const [note, setNote] = useState("");
            const [memory, setMemory] = useState("");
            const [images, setImages] = useState([]);
            const [rating, setRating] = useState(0); 
            const [cityStats, setCityStats] = useState({ avg: 0, count: 0 }); 
            const [checkedPlaces, setCheckedPlaces] = useState([]);
            const [favoriteImage, setFavoriteImage] = useState(null); 
            const [comments, setComments] = useState([]);
            const [newComment, setNewComment] = useState("");
            const [status, setStatus] = useState("visited"); 
            const [category, setCategory] = useState("Genel"); 

            const [feedOpen, setFeedOpen] = useState(false); 
            const [feedItems, setFeedItems] = useState([]); 
            const [feedCommentInputs, setFeedCommentInputs] = useState({});

            const [isEnhancingNote, setIsEnhancingNote] = useState(false);
              
            const [viewedUserFriendCount, setViewedUserFriendCount] = useState(0);
            const [viewedUserLastActive, setViewedUserLastActive] = useState(null);

            const [activeReplyId, setActiveReplyId] = useState(null);
            const [replyText, setReplyText] = useState("");

            const [activeFeedReplyId, setActiveFeedReplyId] = useState(null);
            const [feedReplyText, setFeedReplyText] = useState("");

            const isReadOnly = (myUsername !== currentUsername) && (activeTab === 'personal');
            
            const handleCitySelect = (cityName, center) => {
                setSelectedCity({ name: cityName, latlng: center });
                const existing = markersRef.current.find(m => m.cityName === cityName);
                if(existing) {
                    setNote(existing.note || ""); setMemory(existing.memory || ""); setImages(existing.images || []); setCheckedPlaces(existing.checkedPlaces || []); setComments(existing.comments || []); setFavoriteImage(existing.favoriteImage || null);
                    setStatus(existing.status || "visited"); setCategory(existing.category || "Genel"); setRating(existing.rating || 0);
                } else {
                    setNote(""); setMemory(""); setImages([]); setCheckedPlaces([]); setComments([]); setFavoriteImage(null);
                    setStatus("visited"); setCategory("Genel"); setRating(0);
                }
                setIsModalOpen(true);
            };
            const markersRef = useRef(markers);

            const mainColor = activeTab === 'couple' ? 'bg-pink-600' : 'bg-red-600';
            const subColor = activeTab === 'couple' ? 'bg-pink-500' : 'bg-red-500';
            const lightColor = activeTab === 'couple' ? 'bg-pink-50' : 'bg-red-50';

            const categories = ["Genel", "Yemek", "Doğa", "Tarih", "Eğlence", "Deniz"];
            const coastalCities = [
                "Adana", "Antalya", "Artvin", "Aydın", "Balıkesir", "Bartın", "Bursa", "Çanakkale", "Düzce", 
                "Edirne", "Giresun", "Hatay", "İstanbul", "İzmir", "Kastamonu", "Kırklareli", "Kocaeli", 
                "Mersin", "Muğla", "Ordu", "Rize", "Sakarya", "Samsun", "Sinop", "Tekirdağ", "Trabzon", 
                "Yalova", "Zonguldak"
            ];

            // --- NAVİGASYON VE ARAMA FONKSİYONLARI ---
            const handleUserNavigation = (targetUser) => {
                onViewChange(targetUser);
                setViewMode('map');
                setActiveTab('personal');
                setFeedOpen(false); 
                setHashtagSearch("");
                setIsModalOpen(false); 
                if (window.innerWidth < 768) setSidebarOpen(false); 
            };

            const handleSearch = async (e) => { 
                e.preventDefault(); 
                if(!searchQuery.trim()) return; 
                const target = searchQuery.trim().toLowerCase(); 

                if (target.startsWith("#")) {
                    setHashtagSearch(target);
                    setFeedOpen(true);
                    setSidebarOpen(true);
                    return;
                }

                try { 
                    const doc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_credentials').doc(target).get(); 
                    if(doc.exists) { 
                        handleUserNavigation(target); 
                        setSearchQuery(""); 
                    } else alert("Kullanıcı bulunamadı!"); 
                } catch(e) { alert("Hata."); } 
            };

            const toggleDarkMode = () => {
                setDarkMode(!darkMode);
                if (!darkMode) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            };

            // Not ve Yorumlarda tıklanabilir hashtagler
            const renderClickableNote = (text) => {
                if (!text) return null;
                const parts = text.split(/(\s+)/);
                return parts.map((part, i) => {
                    if (part.trim().startsWith('#')) {
                        return (
                            <span 
                                key={i} 
                                className="text-blue-500 font-bold cursor-pointer hover:underline"
                                onClick={(e) => {
                                    e.stopPropagation();
                                    setHashtagSearch(part.trim());
                                    if (!feedOpen) setFeedOpen(true); // Aramayı tetikleyince akışı aç
                                }}
                            >
                                {part}
                            </span>
                        );
                    }
                    return part;
                });
            };

            // Akışta gizli notları sadece hashtag olarak gösteren fonksiyon
            const renderHashtagsOnly = (text) => {
                if (!text) return null;
                const parts = text.split(/(\s+)/);
                const tags = parts.filter(p => p.trim().startsWith('#'));
                if (tags.length === 0) return null;
                return (
                      <div className="flex flex-wrap gap-1 mb-2">
                        {tags.map((t, i) => (
                            <span key={i} className="text-xs font-bold text-blue-500 hover:text-blue-700 cursor-pointer bg-blue-50 px-1.5 py-0.5 rounded" onClick={(e) => {e.stopPropagation(); setHashtagSearch(t.trim());}}>{t}</span>
                        ))}
                      </div>
                );
            };

            useEffect(() => {
                if (mapRef.current) {
                    setTimeout(() => { mapRef.current.invalidateSize(); }, 300);
                }
            }, [sidebarOpen, viewMode]);

            useEffect(() => {
                const updateActivity = () => {
                    db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_profiles').doc(myUsername).set({
                        lastActive: new Date().toISOString()
                    }, { merge: true });
                };
                updateActivity();
                const interval = setInterval(updateActivity, 60000); 
                return () => clearInterval(interval);
            }, [myUsername]);
              
            useEffect(() => {
                const fRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_friends').doc(currentUsername);
                const unsub = fRef.onSnapshot(doc => {
                    if(doc.exists && doc.data().list) {
                        const list = doc.data().list;
                        setViewedUserFriendCount(list.length);
                        setViewedFriendsList(list);
                    } else {
                        setViewedUserFriendCount(0);
                        setViewedFriendsList([]);
                    }
                });
                return () => unsub();
            }, [currentUsername]);

            useEffect(() => {
                if(!selectedCity) return;
                const cityRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('city_stats').doc(selectedCity.name);
                cityRef.get().then(doc => {
                    if(doc.exists) {
                        const data = doc.data();
                        const avg = data.count > 0 ? (data.sum / data.count).toFixed(1) : 0;
                        setCityStats({ avg, count: data.count });
                    } else {
                        setCityStats({ avg: 0, count: 0 });
                    }
                });
            }, [selectedCity]);

            const enhanceNote = async () => {
                if (!note || !note.trim()) return;
                setIsEnhancingNote(true);
                const prompt = `Bu günlük girişini daha etkileyici, akıcı ve edebi bir dille yeniden yaz. İmla hatalarını düzelt. Orijinal anlamı koru. İşte metin: "${note}"`;
                const result = await callGeminiAPI(prompt);
                if (result) {
                    setNote(result);
                }
                setIsEnhancingNote(false);
            };

            const [lightboxImages, setLightboxImages] = useState([]);
            const [currentImageIndex, setCurrentImageIndex] = useState(0);

            const openLightbox = (imgSrc, allImages) => {
                setLightboxImages(allImages || [imgSrc]);
                setCurrentImageIndex(allImages ? allImages.indexOf(imgSrc) : 0);
                setZoomedImage(imgSrc);
            };
              
            const nextLightbox = (e) => { e.stopPropagation(); setCurrentImageIndex((prev) => (prev + 1) % lightboxImages.length); setZoomedImage(lightboxImages[(currentImageIndex + 1) % lightboxImages.length]); };
            const prevLightbox = (e) => { e.stopPropagation(); setCurrentImageIndex((prev) => (prev - 1 + lightboxImages.length) % lightboxImages.length); setZoomedImage(lightboxImages[(currentImageIndex - 1 + lightboxImages.length) % lightboxImages.length]); };

            useEffect(() => { markersRef.current = markers; }, [markers]);
            const visitedCount = markers.filter(m => m.status !== 'bucket').length;
            const rank = getRank(visitedCount);

            useEffect(() => {
                const notifRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_notifications').doc(myUsername);
                const unsub = notifRef.onSnapshot(doc => { if(doc.exists) setNotifications(doc.data().list || []); else setNotifications([]); });
                return () => unsub();
            }, [myUsername]);

            useEffect(() => {
                const fetchFeed = async () => {
                    let allItems = [];
                    let usersToFetch = [];

                    if (hashtagSearch.startsWith("#")) {
                        const allUsersDoc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_credentials').get();
                        usersToFetch = allUsersDoc.docs.map(d => d.id);
                    } else {
                        // KENDİ ADINI DA EKLEYEREK GÜNCELLEDİM
                        usersToFetch = [myUsername, ...friends]; 
                    }

                    // Parallel Fetching for Better Performance
                    const promises = usersToFetch.map(async (friend) => {
                        try {
                            const [doc, pDoc] = await Promise.all([
                                db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_maps').doc(friend).get(),
                                db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_profiles').doc(friend).get()
                            ]);
                            const fAvatar = pDoc.exists ? pDoc.data().avatar : null;
                            if (doc.exists) {
                                const m = doc.data().markers || [];
                                return m.map(i => ({...i, username: friend, userAvatar: fAvatar}));
                            }
                            return [];
                        } catch (e) {
                            console.error(`Error fetching data for ${friend}:`, e);
                            return [];
                        }
                    });

                    const results = await Promise.all(promises);
                    allItems = results.flat();
                    
                    allItems.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));
                    setFeedItems(allItems);
                };
                if (feedOpen || hashtagSearch) fetchFeed();

                const fetchFriendDetails = async () => {
                    const usersToFetch = [...new Set([...friends, ...viewedFriendsList])];
                    const details = {};
                    for (const friend of usersToFetch) {
                        const doc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_profiles').doc(friend).get();
                        if (doc.exists) { details[friend] = doc.data(); }
                    }
                    setFriendDetails(details);
                };
                fetchFriendDetails();
            }, [friends, feedOpen, viewedFriendsList, hashtagSearch]); 

            const sendNotification = async (targetUser, type, msg=null) => {
                const notifRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_notifications').doc(targetUser);
                const doc = await notifRef.get();
                let currentNotifs = doc.exists ? doc.data().list : [];
                if(type === 'message') {
                    const lastNotif = currentNotifs[currentNotifs.length - 1];
                    if(lastNotif && lastNotif.type === 'message' && lastNotif.from === myUsername) return;
                } else {
                    if(currentNotifs.find(n => n.from === myUsername && n.type === type)) return;
                }
                currentNotifs.push({ id: Date.now(), from: myUsername, type: type, msg: msg, date: new Date().toLocaleDateString('tr-TR') });
                await notifRef.set({ list: currentNotifs });
            };

            const markMessagesAsRead = async () => {
                const unread = notifications.filter(n => n.type === 'message' && n.status !== 'read');
                if(unread.length === 0) return;
                
                const updatedNotifs = notifications.map(n => 
                    (n.type === 'message' && n.status !== 'read') ? { ...n, status: 'read' } : n
                );
                setNotifications(updatedNotifs);
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_notifications').doc(myUsername).set({ list: updatedNotifs });
            };

            const markAllNotifsAsSeen = async () => {
                const unseen = notifications.filter(n => !n.seen);
                if(unseen.length === 0) return;

                const updatedNotifs = notifications.map(n => ({...n, seen: true}));
                setNotifications(updatedNotifs);
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_notifications').doc(myUsername).set({ list: updatedNotifs });
            };

            const handleAcceptNotif = async (notif) => {
                // Bildirimi silmek yerine durumunu güncelle
                const updatedNotifs = notifications.map(n => 
                    n.id === notif.id ? { ...n, status: 'accepted', processedAt: Date.now() } : n
                );
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_notifications').doc(myUsername).set({ list: updatedNotifs });
                
                if(notif.type === 'friend') {
                    const myFriendsRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_friends').doc(myUsername);
                    const myFriendsDoc = await myFriendsRef.get();
                    let myList = myFriendsDoc.exists ? myFriendsDoc.data().list : [];
                    if(!myList.includes(notif.from)) myList.push(notif.from);
                    await myFriendsRef.set({ list: myList }, {merge: true});
                    const otherFriendsRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_friends').doc(notif.from);
                    const otherFriendsDoc = await otherFriendsRef.get();
                    let otherList = otherFriendsDoc.exists ? otherFriendsDoc.data().list : [];
                    if(!otherList.includes(myUsername)) otherList.push(myUsername);
                    await otherFriendsRef.set({ list: otherList }, {merge: true});
                    alert(`${notif.from} ile arkadaş oldunuz!`);
                } else if (notif.type === 'partner') {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_partners').doc(myUsername).set({ partner: notif.from });
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_partners').doc(notif.from).set({ partner: myUsername });
                    setPartner(notif.from);
                    const ids = [myUsername, notif.from].sort();
                    setCoupleId(ids.join('_'));
                    alert(`Tebrikler! ${notif.from} ile sevgili haritanız aktif. ❤️`);
                }
            };

            const handleRejectNotif = async (notif) => {
                // Bildirimi silmek yerine durumunu güncelle
                const updatedNotifs = notifications.map(n => 
                    n.id === notif.id ? { ...n, status: 'rejected', processedAt: Date.now() } : n
                );
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_notifications').doc(myUsername).set({ list: updatedNotifs });
            };

            const removeFriend = async (friendName) => {
                if (!confirm(`${friendName} adlı kişiyi arkadaşlıktan çıkarmak istediğine emin misin?`)) return;

                try {
                    const myRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_friends').doc(myUsername);
                    const myRefDoc = await myRef.get();
                    if (myRefDoc.exists) {
                        const list = myRefDoc.data().list || [];
                        await myRef.set({ list: list.filter(f => f !== friendName) }, { merge: true });
                    }
                    const otherRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_friends').doc(friendName);
                    const otherDoc = await otherRef.get();
                    if (otherDoc.exists) {
                        const list = otherDoc.data().list || [];
                        await otherRef.set({ list: list.filter(f => f !== myUsername) }, { merge: true });
                    }
                    alert("Arkadaşlıktan çıkarıldı.");
                } catch (e) {
                    console.error(e);
                    alert("Bir hata oluştu.");
                }
            };

            const toggleLike = async (targetUser, markerId) => {
                const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_maps').doc(targetUser);
                const doc = await docRef.get();
                if(doc.exists) {
                    let markersList = doc.data().markers || [];
                    const markerIndex = markersList.findIndex(m => m.id === markerId);
                    if(markerIndex > -1) {
                        let likes = markersList[markerIndex].likes || [];
                        if(likes.includes(myUsername)) {
                            likes = likes.filter(u => u !== myUsername);
                        } else {
                            likes.push(myUsername);
                            await sendNotification(targetUser, 'message', `${myUsername} bir paylaşımını beğendi!`);
                        }
                        markersList[markerIndex].likes = likes;
                        await docRef.set({ markers: markersList }, { merge: true });
                        setFeedItems(prev => prev.map(item => { if(item.id === markerId) return {...item, likes: likes}; return item; }));
                    }
                }
            };

            const setFeedInput = (id, val) => setFeedCommentInputs(prev => ({...prev, [id]: val}));
            
            const submitFeedComment = async (targetUser, markerId) => {
                const text = feedCommentInputs[markerId];
                if(!text || !text.trim()) return;
                const cleanText = filterProfanity(text);
                const commentObj = { id: Date.now(), user: myUsername, text: cleanText, date: new Date().toLocaleDateString('tr-TR'), likes: [], replies: [] };
                
                try {
                    const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_maps').doc(targetUser);
                    const doc = await docRef.get();
                    if(doc.exists) {
                        let markersList = doc.data().markers || [];
                        const markerIndex = markersList.findIndex(m => m.id === markerId);
                        if(markerIndex > -1) {
                            if(!markersList[markerIndex].comments) markersList[markerIndex].comments = [];
                            markersList[markerIndex].comments.push(commentObj);
                            await docRef.set({ markers: markersList }, { merge: true });
                            setFeedItems(prev => prev.map(item => { 
                                if (item.id === markerId) return { ...item, comments: [...(item.comments || []), commentObj] }; 
                                return item; 
                            }));
                            setFeedInput(markerId, ""); 
                            await sendNotification(targetUser, 'message', `${myUsername} bir paylaşımına yorum yaptı!`);
                        }
                    }
                } catch(e) { console.error(e); }
            };

            const handleDeleteFeedComment = async (targetUser, markerId, commentId) => {
                if(!confirm("Bu yorumu silmek istediğine emin misin?")) return;
                try {
                    const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_maps').doc(targetUser);
                    const doc = await docRef.get();
                    if(doc.exists) {
                        let markersList = doc.data().markers || [];
                        const markerIndex = markersList.findIndex(m => m.id === markerId);
                        if(markerIndex > -1) {
                            let comments = markersList[markerIndex].comments || [];
                            const updatedComments = comments.filter(c => c.id !== commentId);
                            markersList[markerIndex].comments = updatedComments;
                            await docRef.set({ markers: markersList }, { merge: true });
                            setFeedItems(prev => prev.map(item => {
                                if (item.id === markerId) return { ...item, comments: updatedComments };
                                return item;
                            }));
                        }
                    }
                } catch(e) { console.error("Silme hatası:", e); }
            };

            const toggleFeedCommentLike = async (targetUser, markerId, commentId) => {
                try {
                    const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_maps').doc(targetUser);
                    const doc = await docRef.get();
                    if(doc.exists) {
                        let markersList = doc.data().markers || [];
                        const markerIndex = markersList.findIndex(m => m.id === markerId);
                        if(markerIndex > -1) {
                            let comments = markersList[markerIndex].comments || [];
                            const commentIndex = comments.findIndex(c => c.id === commentId);
                            if(commentIndex > -1) {
                                let likes = comments[commentIndex].likes || [];
                                if(likes.includes(myUsername)) {
                                    likes = likes.filter(u => u !== myUsername);
                                } else {
                                    likes.push(myUsername);
                                }
                                comments[commentIndex].likes = likes;
                                markersList[markerIndex].comments = comments;
                                await docRef.set({ markers: markersList }, { merge: true });
                                setFeedItems(prev => prev.map(item => {
                                    if (item.id === markerId) return { ...item, comments: comments };
                                    return item;
                                }));
                            }
                        }
                    }
                } catch(e) { console.error("Beğeni hatası:", e); }
            };

            const submitFeedReply = async (targetUser, markerId, commentId) => {
                if(!feedReplyText.trim()) return;
                const cleanText = filterProfanity(feedReplyText);
                const replyObj = { id: Date.now(), user: myUsername, text: cleanText, date: new Date().toLocaleDateString('tr-TR') };

                try {
                    const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_maps').doc(targetUser);
                    const doc = await docRef.get();
                    if(doc.exists) {
                        let markersList = doc.data().markers || [];
                        const markerIndex = markersList.findIndex(m => m.id === markerId);
                        if(markerIndex > -1) {
                            let comments = markersList[markerIndex].comments || [];
                            const commentIndex = comments.findIndex(c => c.id === commentId);
                            if(commentIndex > -1) {
                                let replies = comments[commentIndex].replies || [];
                                replies.push(replyObj);
                                comments[commentIndex].replies = replies;
                                markersList[markerIndex].comments = comments;
                                await docRef.set({ markers: markersList }, { merge: true });
                                setFeedItems(prev => prev.map(item => {
                                    if (item.id === markerId) return { ...item, comments: comments };
                                    return item;
                                }));
                                setFeedReplyText("");
                                setActiveFeedReplyId(null);
                            }
                        }
                    }
                } catch(e) { console.error("Yanıt hatası:", e); }
            };

            const breakUpPartner = async () => {
                 if(!confirm("Eşleşmeyi sonlandırmak istediğine emin misin?")) return;
                 await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_partners').doc(myUsername).delete();
                 if(partner) {
                     await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_partners').doc(partner).delete();
                 }
                 setPartner(null);
                 setCoupleId(null);
                 alert("Birliktelik sona erdi.");
            };

            useEffect(() => {
                if (myUsername !== currentUsername) return;
                const unsub = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_partners').doc(myUsername)
                    .onSnapshot(async (doc) => {
                        if (doc.exists && doc.data().partner) {
                            const potentialPartner = doc.data().partner;
                            setPartner(potentialPartner);
                            const ids = [myUsername, potentialPartner].sort();
                            setCoupleId(ids.join('_'));
                        } else {
                            setPartner(null);
                            setCoupleId(null);
                        }
                    });
                return () => unsub();
            }, [myUsername, currentUsername]);

            useEffect(() => {
                let docRef;
                if (myUsername !== currentUsername) {
                    docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_maps').doc(currentUsername);
                } else {
                    if (activeTab === 'couple' && coupleId) {
                         docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('couple_maps').doc(coupleId);
                    } else if (activeTab === 'couple' && !coupleId) {
                         setMarkers([]); 
                         return;
                    } else {
                         docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_maps').doc(myUsername);
                    }
                }
                const unsubscribe = docRef.onSnapshot((doc) => {
                    if (doc.exists) setMarkers(doc.data().markers || []);
                    else setMarkers([]);
                });
                return () => unsubscribe();
            }, [currentUsername, activeTab, coupleId, myUsername]);

            useEffect(() => {
                const profileRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_profiles').doc(currentUsername);
                const unsub = profileRef.onSnapshot(doc => { 
                    if(doc.exists) {
                        if(doc.data().avatar) setUserAvatar(doc.data().avatar); else setUserAvatar(null); 
                        if(doc.data().lastActive) setViewedUserLastActive(doc.data().lastActive);
                    }
                });
                return () => unsub();
            }, [currentUsername]);

            useEffect(() => {
                const friendsRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_friends').doc(myUsername);
                const unsubscribe = friendsRef.onSnapshot((doc) => { if (doc.exists) setFriends(doc.data().list || []); else setFriends([]); });
                return () => unsubscribe();
            }, [myUsername]);

            const saveMarkersToUser = async (targetUser, newMarkers, isCoupleMode = false) => {
                try {
                    let docRef;
                    if (isCoupleMode && coupleId) docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('couple_maps').doc(coupleId);
                    else docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_maps').doc(targetUser);
                    await docRef.set({ markers: newMarkers, lastUpdated: new Date().toISOString() }, { merge: true });
                } catch (e) { 
                    console.error("Kayıt Hatası:", e); 
                    alert("Kayıt sırasında bir hata oluştu! Fotoğraf boyutu çok büyük olabilir veya internet bağlantınız kopmuş olabilir.");
                }
            };

            const handleSave = () => {
                if (!selectedCity) return;
                const cleanNote = filterProfanity(note);
                const cleanMemory = filterProfanity(memory);
                const existingMarker = markers.find(m => m.cityName === selectedCity.name);
                const oldRating = existingMarker ? (existingMarker.rating || 0) : 0;
                
                const newMarker = {
                    id: Date.now(), lat: selectedCity.latlng.lat, lng: selectedCity.latlng.lng,
                    cityName: selectedCity.name, note: cleanNote, memory: cleanMemory, images: images, checkedPlaces: checkedPlaces,
                    comments: comments, favoriteImage: favoriteImage, rating: rating,
                    status: status, category: category, date: new Date().toLocaleDateString('tr-TR'), timestamp: Date.now(), likes: [] 
                };
                const updated = [...markers.filter(m => m.cityName !== selectedCity.name), newMarker];
                setMarkers(updated);
                saveMarkersToUser(currentUsername, updated, activeTab === 'couple');
                
                if (rating > 0) {
                    const cityRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('city_stats').doc(selectedCity.name);
                    const incrementSum = rating - oldRating;
                    const incrementCount = oldRating === 0 ? 1 : 0;
                    
                    if (incrementSum !== 0 || incrementCount !== 0) {
                        cityRef.set({
                            sum: firebase.firestore.FieldValue.increment(incrementSum),
                            count: firebase.firestore.FieldValue.increment(incrementCount)
                        }, { merge: true });
                    }
                }
                setIsModalOpen(false);
            };

            const updateMarkerWithComments = (newComments) => {
                const originalMarker = markers.find(m => m.cityName === selectedCity.name) || {};
                const newMarker = {
                    id: originalMarker.id || Date.now(),
                    lat: selectedCity.latlng.lat,
                    lng: selectedCity.latlng.lng,
                    cityName: selectedCity.name,
                    note: note, // keep existing note
                    memory: memory, // keep existing memory
                    images: images,
                    checkedPlaces: checkedPlaces,
                    comments: newComments,
                    favoriteImage: favoriteImage,
                    rating: rating,
                    status: status,
                    category: category,
                    date: originalMarker.date || new Date().toLocaleDateString('tr-TR'),
                    timestamp: originalMarker.timestamp || Date.now(),
                    likes: originalMarker.likes || []
                };
                const updatedMarkers = [...markers.filter(m => m.cityName !== selectedCity.name), newMarker];
                setMarkers(updatedMarkers);
                saveMarkersToUser(currentUsername, updatedMarkers, activeTab === 'couple');
            };

            const toggleCommentLike = (commentId) => {
                const updatedComments = comments.map(c => {
                    if (c.id === commentId) {
                        const likes = c.likes || [];
                        if (likes.includes(myUsername)) {
                            return { ...c, likes: likes.filter(u => u !== myUsername) };
                        } else {
                            return { ...c, likes: [...likes, myUsername] };
                        }
                    }
                    return c;
                });
                setComments(updatedComments);
                updateMarkerWithComments(updatedComments);
            };

            const submitReply = (commentId) => {
                if (!replyText.trim()) return;
                const replyObj = {
                    id: Date.now(),
                    user: myUsername,
                    text: filterProfanity(replyText),
                    date: new Date().toLocaleDateString('tr-TR'),
                    likes: []
                };
                const updatedComments = comments.map(c => {
                    if (c.id === commentId) {
                        return { ...c, replies: [...(c.replies || []), replyObj] };
                    }
                    return c;
                });
                setComments(updatedComments);
                setReplyText("");
                setActiveReplyId(null);
                updateMarkerWithComments(updatedComments);
            };

            const handleAddComment = () => {
                if (!newComment.trim()) return;
                const cleanText = filterProfanity(newComment);
                const commentObj = { id: Date.now(), user: myUsername, text: cleanText, date: new Date().toLocaleDateString('tr-TR'), likes: [], replies: [] };
                const updatedComments = [...comments, commentObj];
                setComments(updatedComments);
                setNewComment("");
                const originalMarker = markers.find(m => m.cityName === selectedCity.name) || {};
                const newMarker = {
                    id: originalMarker.id || Date.now(), lat: selectedCity.latlng.lat, lng: selectedCity.latlng.lng,
                    cityName: selectedCity.name, note: note, memory: memory, images: images, checkedPlaces: checkedPlaces,
                    comments: updatedComments, favoriteImage: favoriteImage, rating: rating,
                    status: status, category: category, date: new Date().toLocaleDateString('tr-TR'), timestamp: Date.now(), likes: originalMarker.likes || []
                };
                const updatedMarkers = [...markers.filter(m => m.cityName !== selectedCity.name), newMarker];
                saveMarkersToUser(currentUsername, updatedMarkers, activeTab === 'couple');
            };

            const handleAvatarUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                try {
                    const base64 = await compressImage(file);
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_profiles').doc(myUsername).set({ avatar: base64 }, { merge: true });
                } catch (err) { alert("Fotoğraf yüklenemedi."); }
            };
            
            const linkPartner = async (targetUsername) => { await sendNotification(targetUsername, 'partner'); alert(`Eşleşme isteği gönderildi.`); setIsPartnerModalOpen(false); };
            const addFriend = async (friendName) => { if(friendName === myUsername) return; if(friends.includes(friendName)) { alert("Zaten arkadaşsınız."); return; } await sendNotification(friendName, 'friend'); alert(`${friendName} eklendi!`); };
            
            const handleDelete = async (name) => { 
                if(!confirm(`${name} verilerini tamamen silmek ve haritayı sıfırlamak istediğine emin misin?`)) return;
                
                // Puan istatistiklerini temizle
                const existing = markers.find(m => m.cityName === name);
                if (existing && existing.rating > 0) {
                    const cityRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('city_stats').doc(name);
                    try {
                        await cityRef.set({
                            sum: firebase.firestore.FieldValue.increment(-existing.rating),
                            count: firebase.firestore.FieldValue.increment(-1)
                        }, { merge: true });
                    } catch(e) { console.error("İstatistik silme hatası:", e); }
                }

                const updated = markers.filter(m => m.cityName !== name); 
                setMarkers(updated); 
                saveMarkersToUser(currentUsername, updated, activeTab === 'couple');
                setIsModalOpen(false);
            };

            const handleImage = async (e) => { 
                const files = Array.from(e.target.files); 
                try {
                    const compressedFiles = await Promise.all(files.map(file => compressImage(file)));
                    setImages(prev => { 
                        const newImages = [...prev, ...compressedFiles]; 
                        if (!favoriteImage && newImages.length > 0) setFavoriteImage(newImages[0]); 
                        return newImages; 
                    });
                } catch (error) {
                    console.error("Resim yükleme hatası:", error);
                    alert("Fotoğraflar yüklenirken bir sorun oluştu.");
                }
            };
            const toggleCheckedPlace = (place) => { if(isReadOnly) return; setCheckedPlaces(prev => prev.includes(place) ? prev.filter(p=>p!==place) : [...prev, place]); };
            
            const calculateProgress = (cityName, visitedPlaces) => { 
                const visitedCount = visitedPlaces ? visitedPlaces.length : 0;
                if (visitedCount === 0) return 0;
                let totalPossible = 0;
                const data = citySuggestionsData[cityName];
                if (data) {
                    const uniqueItems = new Set();
                    Object.values(data).forEach(categoryList => {
                        if (Array.isArray(categoryList)) { categoryList.forEach(item => uniqueItems.add(item)); }
                    });
                    totalPossible = uniqueItems.size;
                }
                if (totalPossible === 0) totalPossible = 3;
                return Math.min(100, Math.round((visitedCount / totalPossible) * 100)); 
            };

            useEffect(() => {
                if (geoJsonLayer && labelLayerRef.current) {
                    labelLayerRef.current.clearLayers();
                    if (imageMarkersRef.current) imageMarkersRef.current.clearLayers();

                    const filteredMarkers = markers.filter(m => categoryFilter === "Tümü" || m.category === categoryFilter);

                    geoJsonLayer.eachLayer(layer => {
                        const cityName = layer.feature.properties.name;
                        const marker = filteredMarkers.find(m => m.cityName === cityName);
                        let fillColor = '#ffffff'; let fillOpacity = 0.5;

                        if (marker) {
                            if (marker.status === 'bucket') { fillColor = '#eab308'; fillOpacity = 0.8; }
                            else { fillColor = activeTab === 'couple' ? '#ec4899' : '#ef4444'; fillOpacity = 0.9; }
                        } else {
                            fillColor = '#9ca3af'; 
                        }

                        layer.setStyle({ fillColor: fillColor, fillOpacity: fillOpacity, color: 'white', weight: 1 });
                        
                        let center = layer.getBounds().getCenter();
                        if(customCityCenters[cityName]) center = L.latLng(customCityCenters[cityName]);

                        let labelContent = `<div class="city-label">${cityName}</div>`;
                        let progress = 0;
                        if (marker && marker.status !== 'bucket') {
                            progress = calculateProgress(cityName, marker.checkedPlaces);
                            if (progress > 0) labelContent = `<div class="city-label"><div>${cityName}</div><div class="city-label-progress">%${progress}</div></div>`;
                        }
                        
                        if (showCityNames) { 
                            L.marker(center, { icon: L.divIcon({className: 'hidden'}), interactive: false })
                              .bindTooltip(labelContent, { permanent: true, direction: 'center', className: '' }).addTo(labelLayerRef.current);
                        }

                        if (progress === 100 && (marker.favoriteImage || (marker.images && marker.images.length > 0))) {
                            const imgUrl = marker.favoriteImage || marker.images[0];
                            const icon = L.divIcon({ className: 'custom-img-icon', html: `<img src="${imgUrl}" class="city-marker-img" />`, iconSize: [48, 48], iconAnchor: [24, 24] });
                            L.marker(layer.getBounds().getCenter(), { icon: icon, interactive: false }).addTo(imageMarkersRef.current);
                        }
                    });
                }
            }, [markers, geoJsonLayer, activeTab, categoryFilter, showCityNames]);

            // Harita Init
            useEffect(() => {
                if (mapRef.current) return;
                const container = document.getElementById('map-container');
                if(!container) return;
                if(container._leaflet_id) { container._leaflet_id = null; container.innerHTML = ""; }
                
                const mapInstance = L.map('map-container', { 
                    preferCanvas: true, 
                    minZoom: 5, 
                    zoomControl: false,
                    maxBounds: [[35, 25], [43, 45]],
                    maxBoundsViscosity: 1.0 
                }).setView([39.0, 35.5], 6);
                
                L.control.zoom({ position: 'bottomright' }).addTo(mapInstance);
                mapRef.current = mapInstance;
                
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}', { 
                    attribution: 'Esri', 
                    maxZoom: 16,
                    noWrap: true,
                    bounds: [[-90, -180], [90, 180]]
                }).addTo(mapInstance);
                
                const labelLayer = L.layerGroup().addTo(mapInstance);
                labelLayerRef.current = labelLayer;
                const imageLayer = L.layerGroup().addTo(mapInstance);
                imageMarkersRef.current = imageLayer;

                fetch('https://raw.githubusercontent.com/codeforgermany/click_that_hood/main/public/data/turkey.geojson')
                    .then(res => res.json())
                    .then(data => {
                        const layer = L.geoJSON(data, {
                            interactive: true,
                            style: () => ({ 
                                fillColor: '#9ca3af', 
                                weight: 1, 
                                opacity: 0.5, 
                                color: 'white', 
                                fillOpacity: 0.5,
                                className: 'cursor-pointer'
                            }),
                            onEachFeature: (feature, layer) => {
                                const cityName = feature.properties.name;
                                let center = layer.getBounds().getCenter();
                                if(customCityCenters[cityName]) center = L.latLng(customCityCenters[cityName]);
                                
                                layer.on('click', () => {
                                    handleCitySelect(cityName, center);
                                });
                            }
                        }).addTo(mapInstance);
                        setGeoJsonLayer(layer);
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error("Harita verisi yüklenemedi:", err);
                        setLoading(false);
                    });
                return () => { if(mapRef.current) { mapRef.current.remove(); mapRef.current = null; } };
            }, []);

            const filteredFeedItems = feedItems.filter(item => {
                const tag = hashtagSearch.trim().toLowerCase();
                if(!tag) return true;
                
                // Ana not kontrolü
                const noteMatch = item.note && item.note.toLowerCase().includes(tag);
                
                // Yorumlarda kontrol
                const commentMatch = item.comments && item.comments.some(c => 
                    (c.text && c.text.toLowerCase().includes(tag)) || 
                    (c.replies && c.replies.some(r => r.text && r.text.toLowerCase().includes(tag)))
                );

                return noteMatch || commentMatch;
            });

            return (
                <div className={`flex h-full relative ${darkMode ? 'dark' : ''}`}>
                    <div className={`absolute md:relative z-20 h-full bg-white dark:bg-gray-800 shadow-xl transition-all duration-300 ease-in-out flex flex-col ${sidebarOpen ? 'w-full md:w-96 translate-x-0' : 'w-0 -translate-x-full overflow-hidden'}`}>
                        <div className={`p-5 ${mainColor} text-white shadow-md transition-colors duration-500`}>
                             <div className="flex justify-between items-center mb-4">
                                <div className="flex items-center gap-3 font-bold cursor-pointer hover:opacity-90 transition-opacity" onClick={() => setViewMode('map')}>
                                    <div className="relative group">
                                        <div 
                                            className={`w-12 h-12 rounded-full bg-white/20 flex items-center justify-center overflow-hidden border-2 border-white/50 shadow-sm ${userAvatar ? 'cursor-zoom-in hover:scale-105 transition-transform' : ''}`}
                                            onClick={(e) => {
                                                if (userAvatar) {
                                                    e.stopPropagation();
                                                    openLightbox(userAvatar, [userAvatar]);
                                                }
                                            }}
                                        >
                                            {userAvatar ? <img src={userAvatar} className="w-full h-full object-cover" /> : <Icon name="user" className="w-6 h-6"/>}
                                        </div>
                                        {!isReadOnly && activeTab === 'personal' && (
                                            <label onClick={(e)=>e.stopPropagation()} className="absolute -bottom-1 -right-1 bg-white text-black rounded-full p-1 cursor-pointer shadow-md hover:bg-gray-100 transition-colors"><Icon name="camera" className="w-3 h-3"/><input type="file" className="hidden" accept="image/*" onChange={handleAvatarUpload} /></label>
                                        )}
                                    </div>
                                    <div className="flex flex-col">
                                        <h1 className="text-xl leading-tight font-black tracking-tight">@{currentUsername}</h1>
                                        {/* AKTİFLİK DURUMU */}
                                        <div className="flex items-center gap-1.5 mt-0.5">
                                            <div className={`w-2 h-2 rounded-full ${formatTimeAgo(viewedUserLastActive) === 'Çevrimiçi' ? 'bg-green-400 animate-pulse' : 'bg-gray-400 opacity-60'}`}></div>
                                            <span className="text-[10px] font-bold opacity-90">{formatTimeAgo(viewedUserLastActive)}</span>
                                        </div>
                                        
                                        {/* ARKADAŞ EKLE BUTONU */}
                                        {isReadOnly && !friends.includes(currentUsername) && (
                                            <button 
                                                onClick={() => addFriend(currentUsername)}
                                                className="mt-2 flex items-center gap-1 bg-white text-red-600 px-3 py-1 rounded-full text-[10px] font-bold shadow-md hover:bg-gray-100 transition-all active:scale-95 w-fit"
                                            >
                                                <Icon name="user-plus" className="w-3 h-3"/> Arkadaş Ekle
                                            </button>
                                        )}
                                        
                                        <div className="flex items-center gap-3 text-xs font-medium text-white/80 mt-1">
                                            <span><strong>{viewedUserFriendCount}</strong> Arkadaş</span>
                                        </div>
                                        <div className="text-xs opacity-80 font-medium flex items-center gap-1 mt-1.5 bg-black/10 px-1.5 py-0.5 rounded w-fit"><Icon name={rank.icon} className="w-3 h-3"/> {rank.title}</div>
                                    </div>
                                </div>
                                <div className="flex gap-2 items-center">
                                    <button onClick={()=> { setIsNotifOpen(!isNotifOpen); if(!isNotifOpen) markAllNotifsAsSeen(); }} className="bg-white/20 p-2 rounded-full hover:bg-white/30 relative transition-colors">
                                        <Icon name="bell" className="w-5 h-5"/>
                                        {notifications.some(n => !n.seen) && <span className="absolute top-1 right-1 w-2.5 h-2.5 bg-yellow-400 rounded-full border-2 border-red-600 animate-pulse"></span>}
                                    </button>
                                    <div className="flex flex-col gap-1">
                                         <button onClick={()=>setSidebarOpen(false)} className="bg-black/20 p-2 rounded-full hover:bg-black/40"><Icon name="x" className="w-4 h-4"/></button>
                                         <div className="flex gap-1">
                                              {!isReadOnly && <button onClick={()=>setIsSettingsOpen(true)} className="bg-white/20 p-1.5 rounded hover:bg-white/30" title="Ayarlar"><Icon name="settings" className="w-4 h-4"/></button>}
                                              {isReadOnly &&
                                                  <button onClick={()=>handleUserNavigation(myUsername)} className="bg-white text-red-600 px-2 py-1 rounded text-xs font-bold hover:bg-gray-100 transition-colors shadow-sm" title="Profilime Dön"><Icon name="user" className="w-4 h-4"/></button> 
                                              }
                                         </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="flex gap-2 items-center justify-between mb-3 bg-black/10 p-2 rounded-lg mx-5 mt-4 overflow-x-auto custom-scrollbar">
                                 <button onClick={()=>setIsCinemaOpen(true)} className="flex-1 min-w-[60px] bg-white/10 hover:bg-white/20 py-1.5 rounded flex flex-col items-center text-[10px] font-bold gap-0.5 transition-colors"><Icon name="play" className="w-4 h-4"/> Sinema</button>
                                 <button onClick={()=> { setFeedOpen(!feedOpen); setHashtagSearch(""); }} className={`flex-1 min-w-[60px] py-1.5 rounded flex flex-col items-center text-[10px] font-bold gap-0.5 transition-colors ${feedOpen && !hashtagSearch ? 'bg-white text-red-600 shadow' : 'bg-white/10 hover:bg-white/20 text-white'}`}><Icon name="activity" className="w-4 h-4"/> Akış</button>
                                 <button onClick={()=> { setIsMessagesOpen(true); markMessagesAsRead(); }} className="flex-1 min-w-[60px] bg-white/10 hover:bg-white/20 py-1.5 rounded flex flex-col items-center text-[10px] font-bold gap-0.5 transition-colors relative">
                                    <Icon name="message-circle" className="w-4 h-4"/> 
                                    Mesajlar
                                    {notifications.filter(n => n.type === 'message' && n.status !== 'read').length > 0 && (
                                        <span className="absolute top-0 right-1 bg-red-500 text-white text-[8px] px-1 rounded-full border border-white">
                                            {notifications.filter(n => n.type === 'message' && n.status !== 'read').length}
                                        </span>
                                    )}
                                 </button>
                                 <button onClick={()=>setIsLeaderboardOpen(true)} className="flex-1 min-w-[60px] bg-white/10 hover:bg-white/20 py-1.5 rounded flex flex-col items-center text-[10px] font-bold gap-0.5 transition-colors"><Icon name="trophy" className="w-4 h-4"/> Liderler</button>
                            </div>

                            <div className="flex bg-black/20 rounded-lg p-1 mb-3 mx-5">
                                {!isReadOnly && (
                                    <>
                                        <button onClick={() => { setActiveTab('personal'); setViewMode('map'); }} className={`flex-1 py-1.5 rounded-md text-xs font-bold flex items-center justify-center gap-1 transition-all ${activeTab === 'personal' && viewMode === 'map' ? 'bg-white text-red-600 shadow' : 'text-white hover:bg-white/10'}`}><Icon name="user" className="w-3 h-3"/> Bireysel</button>
                                        <button onClick={() => {!partner ? setIsPartnerModalOpen(true) : setActiveTab('couple'); setViewMode('map');}} className={`flex-1 py-1.5 rounded-md text-xs font-bold flex items-center justify-center gap-1 transition-all ${activeTab === 'couple' && viewMode === 'map' ? 'bg-white text-pink-600 shadow' : 'text-white hover:bg-white/10'}`}><Icon name="heart" className={`w-3 h-3 ${partner ? 'fill-current' : ''}`}/> Sevgili</button>
                                    </>
                                )}
                                <button onClick={() => setViewMode('friends')} className={`flex-1 py-1.5 rounded-md text-xs font-bold flex items-center justify-center gap-1 transition-all ${viewMode === 'friends' ? 'bg-white text-indigo-600 shadow' : 'text-white hover:bg-white/10'}`}><Icon name="users" className="w-3 h-3"/> Arkadaşlar</button>
                            </div>

                            <form onSubmit={handleSearch} className="relative mx-5 mb-2">
                                <input className="w-full pl-9 py-2 rounded-lg text-black text-sm shadow-sm border-none focus:ring-2 focus:ring-red-300 focus:outline-none" placeholder="Kullanıcı veya #etiket ara..." value={searchQuery} onChange={e=>setSearchQuery(e.target.value)}/>
                                <Icon name="search" className="w-4 h-4 text-gray-400 absolute left-3 top-2.5"/>
                            </form>
                        </div>

                        {!isReadOnly && activeTab === 'couple' && partner && (
                            <div className="px-5 py-2 flex items-center justify-between bg-pink-50 dark:bg-pink-900/20 border-b dark:border-pink-800/50 animate-fadeIn">
                                <div className="flex items-center gap-2">
                                    <Icon name="heart" className="w-4 h-4 text-pink-500 fill-pink-500"/>
                                    <span className="text-xs font-bold text-pink-700 dark:text-pink-300">@{partner} ile sevgilisin</span>
                                </div>
                                <button onClick={breakUpPartner} className="text-[10px] bg-white dark:bg-gray-800 text-red-500 px-2 py-1 rounded border border-red-200 dark:border-red-900/50 font-bold hover:bg-red-50 transition-colors">Ayrıl</button>
                            </div>
                        )}

                        {viewMode === 'friends' ? (
                             <div className="flex-1 overflow-y-auto p-4 bg-gray-50 dark:bg-gray-900 custom-scrollbar">
                                <h2 className="font-bold text-gray-700 dark:text-white mb-3 flex items-center gap-2 text-sm uppercase tracking-wide opacity-70"><Icon name="users" className="w-4 h-4"/> Arkadaşlarım</h2>
                                {viewedFriendsList.map((f, i) => (
                                    <div key={i} className="bg-white dark:bg-gray-700 p-3 rounded-xl border border-gray-100 dark:border-gray-600 mb-2 flex justify-between items-center cursor-pointer hover:shadow-md transition-all">
                                            <div className="flex items-center gap-3" onClick={() => handleUserNavigation(f)}>
                                                <div className="relative">
                                                    <div className="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold text-xs">
                                                         {friendDetails[f]?.avatar ? <img src={friendDetails[f].avatar} className="w-full h-full rounded-full object-cover"/> : f.substring(0,2).toUpperCase()}
                                                    </div>
                                                    <div className={`absolute -bottom-0.5 -right-0.5 w-2.5 h-2.5 rounded-full border-2 border-white dark:border-gray-700 ${formatTimeAgo(friendDetails[f]?.lastActive) === 'Çevrimiçi' ? 'bg-green-500' : 'bg-gray-300'}`}></div>
                                                </div>
                                                <div className="flex flex-col">
                                                    <div className="font-bold text-gray-800 dark:text-white text-sm">@{f}</div>
                                                    <div className="text-[9px] text-gray-400 font-bold uppercase">{formatTimeAgo(friendDetails[f]?.lastActive)}</div>
                                                </div>
                                            </div>
                                            {!isReadOnly && (
                                                <div className="flex gap-1">
                                                    <button onClick={() => setCurrentChatFriend(f)} className="text-indigo-600 hover:text-indigo-800 bg-indigo-50 dark:bg-indigo-900 p-2 rounded-full transition-colors hover:bg-indigo-100 dark:hover:bg-indigo-800 shadow-sm" title="Mesaj Gönder">
                                                        <Icon name="message-circle" className="w-4 h-4"/>
                                                    </button>
                                                    <button onClick={() => removeFriend(f)} className="text-red-500 bg-red-50 dark:bg-red-900/20 p-2 rounded-full hover:bg-red-100 dark:hover:bg-red-900/40 transition-colors shadow-sm" title="Arkadaşlıktan Çıkar">
                                                        <Icon name="user-x" className="w-4 h-4"/>
                                                    </button>
                                                </div>
                                            )}
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <>
                                <div className={`px-4 py-3 ${lightColor} dark:bg-gray-800 border-b dark:border-gray-700 transition-colors duration-500 shadow-sm relative z-10`}>
                                    <div className="flex items-center justify-between mb-2">
                                        <div className={`text-xs font-bold uppercase tracking-wide ${activeTab === 'couple' ? 'text-pink-800 dark:text-pink-300' : 'text-red-800 dark:text-red-300'}`}>
                                            Gezilen: {markers.length} / 81
                                        </div>
                                        <select value={categoryFilter} onChange={(e) => setCategoryFilter(e.target.value)} className="text-[10px] font-bold border border-gray-200 dark:border-gray-600 rounded-lg px-2 py-1 bg-white dark:bg-gray-700 dark:text-white focus:outline-none focus:border-blue-500 transition-colors shadow-sm cursor-pointer">
                                            <option value="Tümü">Tümü</option>
                                            {categories.map(c => <option key={c} value={c}>{c}</option>)}
                                        </select>
                                    </div>
                                    <div className="w-full bg-gray-200 dark:bg-gray-700 h-2.5 rounded-full overflow-hidden shadow-inner"><div className={`h-2.5 rounded-full transition-all duration-1000 ease-out ${subColor}`} style={{width: `${(markers.length/81)*100}%`}}></div></div>
                                    {isReadOnly && <div className="mt-2 text-xs bg-blue-100 text-blue-700 p-1.5 rounded-md text-center flex items-center justify-center gap-1 font-bold border border-blue-200"><Icon name="eye" className="w-3 h-3"/> {currentUsername}'in Haritası</div>}
                                </div>

                                <div className="flex-1 overflow-y-auto p-3 space-y-3 bg-gray-50 dark:bg-gray-900 custom-scrollbar z-0">
                                    {markers.length === 0 && <div className="text-center text-gray-400 mt-10 text-sm">Hiç kayıt bulunamadı.</div>}
                                    {markers.filter(m => categoryFilter === "Tümü" || m.category === categoryFilter).map((m, idx) => (
                                        <div key={m.id} onClick={()=> handleCitySelect(m.cityName, {lat: m.lat, lng: m.lng})} className={`bg-white dark:bg-gray-700 p-4 rounded-xl border dark:border-gray-600 shadow-sm hover:shadow-lg cursor-pointer border-l-4 ${m.status === 'bucket' ? 'border-l-yellow-400' : 'border-l-green-500'}`}>
                                            <div className="flex justify-between font-bold text-gray-800 dark:text-white items-center mb-1">
                                                <span className="text-base">{m.cityName}</span>
                                                {!isReadOnly && <button onClick={(e)=>{e.stopPropagation(); handleDelete(m.cityName)}} className="text-gray-300 hover:text-red-500 transition-colors p-1.5 rounded-full hover:bg-red-50 dark:hover:bg-red-900/20"><Icon name="trash-2" className="w-4 h-4"/></button>}
                                            </div>
                                            <div className="text-[10px] text-gray-400 mb-2">{m.date} | {m.category}</div>
                                            {m.images && m.images[0] && <img src={m.images[0]} className="w-full h-32 object-cover rounded-lg mb-2 shadow-sm"/>}
                                            {/* GÜNLÜK: SADECE HARİTA SAHİBİ GÖRÜR */}
                                            {!isReadOnly && m.note && <p className="text-xs text-gray-500 dark:text-gray-300 italic line-clamp-2 leading-relaxed">"{m.note}"</p>}
                                        </div>
                                    ))}
                                </div>
                            </>
                        )}
                    </div>

                    {!sidebarOpen && <button onClick={()=>setSidebarOpen(true)} className={`absolute top-4 left-4 z-10 bg-white dark:bg-gray-700 p-3 rounded-full shadow-lg text-red-600 hover:scale-110 active:scale-95 transition-all`}><Icon name="menu" className="w-6 h-6"/></button>}
                    
                    {feedOpen && (
                        <div className="absolute top-0 right-0 h-full w-full md:w-80 bg-white dark:bg-gray-800 shadow-2xl z-30 flex flex-col border-l border-gray-200 dark:border-gray-700 animate-fadeIn">
                            <div className="p-4 bg-indigo-600 text-white flex justify-between items-center shadow-md">
                                <h3 className="font-bold flex items-center gap-2"><Icon name="activity" className="w-5 h-5"/> {hashtagSearch ? `Keşfet: ${hashtagSearch}` : "Akış"}</h3>
                                <button onClick={()=> { setFeedOpen(false); setHashtagSearch(""); }} className="hover:bg-white/20 p-1 rounded-full"><Icon name="x" className="w-5 h-5"/></button>
                            </div>
                            <div className="p-3 border-b dark:border-gray-700">
                                <div className="relative">
                                    <Icon name="hash" className="absolute left-3 top-2.5 w-4 h-4 text-gray-400"/>
                                    <input 
                                        type="text" 
                                        placeholder="Etiketle ara (#eskişehir)" 
                                        value={hashtagSearch}
                                        onChange={e=>setHashtagSearch(e.target.value)}
                                        className="w-full pl-9 pr-4 py-2 text-sm rounded-lg border dark:border-gray-600 dark:bg-gray-700 dark:text-white outline-none focus:ring-2 focus:ring-indigo-500"
                                    />
                                </div>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 space-y-6 bg-gray-50 dark:bg-gray-900 custom-scrollbar">
                                {filteredFeedItems.length === 0 && <p className="text-center text-gray-400 text-sm mt-10">Paylaşım bulunamadı.</p>}
                                {filteredFeedItems.map((item, i) => {
                                    const isLiked = item.likes?.includes(myUsername);
                                    return (
                                        <div key={item.id || i} className="bg-white dark:bg-gray-700 rounded-xl shadow-md border dark:border-gray-600 overflow-hidden animate-fadeIn">
                                            <div className="p-3 flex justify-between items-center bg-gray-50/50 dark:bg-gray-800/50">
                                                <div className="flex items-center gap-2 cursor-pointer" onClick={() => handleUserNavigation(item.username)}>
                                                    <div className="w-6 h-6 rounded-full bg-indigo-100 flex items-center justify-center text-[10px] font-bold text-indigo-600 overflow-hidden">
                                                        {item.userAvatar ? <img src={item.userAvatar} className="w-full h-full object-cover"/> : item.username[0].toUpperCase()}
                                                    </div>
                                                    <span className="font-bold text-xs text-indigo-600">@{item.username}</span>
                                                </div>
                                                <span className="text-[10px] text-gray-400 font-bold uppercase tracking-tighter">{item.cityName}</span>
                                            </div>
                                            
                                            {/* Ziyaret Bilgisi: Fotoğrafın üstüne taşındı */}
                                            <div className="px-3 pt-3 pb-1 text-sm text-gray-800 dark:text-gray-200">
                                                <div className="bg-blue-50 dark:bg-blue-900/20 p-2 rounded-lg border border-blue-100 dark:border-blue-800/30">
                                                    <span className="font-bold text-indigo-600 dark:text-indigo-400">@{item.username}</span>, <span className="font-bold">{item.cityName}</span> şehrini {item.status === 'bucket' ? 'gitmek istediği yerlere ekledi 🎯' : 'ziyaret etti 🌍'}.
                                                </div>
                                            </div>

                                            {item.images && item.images[0] && <img src={item.images[0]} className="w-full h-44 object-cover cursor-zoom-in" onClick={() => openLightbox(item.images[0], item.images)}/>}
                                            
                                            <div className="p-3">
                                                {/* GÜNLÜK (NOTLAR) GİZLİLİĞİ: TAM METİN GİZLİ, SADECE HASHTAGLER GÖSTERİLİR */}
                                                {renderHashtagsOnly(item.note)}
                                                
                                                <div className="flex items-center gap-4 border-t dark:border-gray-600 pt-3 mb-3">
                                                    <button onClick={() => toggleLike(item.username, item.id)} className="flex items-center gap-1 group">
                                                        <Icon name="heart" className={`w-5 h-5 transition-all ${isLiked ? 'text-red-500 fill-red-500 scale-110' : 'text-gray-400 group-hover:text-red-400'}`}/>
                                                        <span className={`text-[10px] font-bold ${isLiked ? 'text-red-500' : 'text-gray-500'}`}>{item.likes?.length || 0}</span>
                                                    </button>
                                                    <div className="flex items-center gap-1 text-gray-400">
                                                        <Icon name="message-square" className="w-5 h-5"/>
                                                        <span className="text-[10px] font-bold">{item.comments?.length || 0}</span>
                                                    </div>
                                                </div>

                                                {item.comments && item.comments.length > 0 && (
                                                    <div className="space-y-2 mb-3 max-h-24 overflow-y-auto bg-gray-50 dark:bg-gray-800 p-2 rounded-lg">
                                                        {item.comments.map(c => (
                                                            <div key={c.id} className="text-[10px]">
                                                                <div className="flex justify-between items-start">
                                                                    <div className="flex-1">
                                                                        <span onClick={(e) => { e.stopPropagation(); handleUserNavigation(c.user); }} className="font-bold text-indigo-600 mr-1 cursor-pointer hover:underline">@{c.user}</span>
                                                                        <span className="text-gray-600 dark:text-gray-300">{renderClickableNote(c.text)}</span>
                                                                    </div>
                                                                    {/* YORUM SİLME BUTONU */}
                                                                    {(c.user === myUsername || item.username === myUsername) && (
                                                                        <button onClick={() => handleDeleteFeedComment(item.username, item.id, c.id)} className="text-red-400 hover:text-red-600 p-0.5 ml-2 transition-colors">
                                                                            <Icon name="trash-2" className="w-3 h-3"/>
                                                                        </button>
                                                                    )}
                                                                </div>
                                                                
                                                                {/* YORUM AKSİYONLARI (BEĞEN/YANITLA) */}
                                                                <div className="flex items-center gap-2 mt-1 ml-1">
                                                                    <button onClick={() => toggleFeedCommentLike(item.username, item.id, c.id)} className={`flex items-center gap-0.5 transition-colors ${c.likes?.includes(myUsername) ? 'text-red-500' : 'text-gray-400 hover:text-red-400'}`}>
                                                                        <Icon name="heart" className={`w-3 h-3 ${c.likes?.includes(myUsername) ? 'fill-current' : ''}`} />
                                                                        <span className="text-[9px]">{c.likes?.length || 0}</span>
                                                                    </button>
                                                                    <button onClick={() => setActiveFeedReplyId(activeFeedReplyId === c.id ? null : c.id)} className="text-[9px] text-gray-400 hover:text-indigo-500 font-bold transition-colors">Yanıtla</button>
                                                                </div>

                                                                {/* YANIT GİRİŞ ALANI (AKIŞ) */}
                                                                {activeFeedReplyId === c.id && (
                                                                    <div className="mt-1 flex gap-1 animate-fadeIn">
                                                                        <input 
                                                                            type="text" 
                                                                            value={feedReplyText} 
                                                                            onChange={e=>setFeedReplyText(e.target.value)} 
                                                                            placeholder="Yanıt..." 
                                                                            className="flex-1 border border-gray-200 dark:border-gray-600 rounded-full px-2 py-1 text-[9px] outline-none dark:bg-gray-700 dark:text-white"
                                                                            autoFocus
                                                                        />
                                                                        <button onClick={() => submitFeedReply(item.username, item.id, c.id)} className="text-indigo-600 hover:text-indigo-800"><Icon name="send" className="w-3 h-3"/></button>
                                                                    </div>
                                                                )}

                                                                {/* YANITLARI LİSTELE */}
                                                                {c.replies && c.replies.length > 0 && (
                                                                    <div className="mt-1 pl-2 border-l border-gray-300 dark:border-gray-600 space-y-1">
                                                                        {c.replies.map(r => (
                                                                            <div key={r.id} className="text-[9px] text-gray-500 dark:text-gray-400">
                                                                                <span onClick={(e) => { e.stopPropagation(); handleUserNavigation(r.user); }} className="font-bold text-indigo-500 mr-1 cursor-pointer hover:underline">@{r.user}</span>
                                                                                {renderClickableNote(r.text)}
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}

                                                <div className="flex gap-1.5 items-center">
                                                    <input 
                                                        type="text" 
                                                        placeholder="Yorum yap..." 
                                                        value={feedCommentInputs[item.id] || ""}
                                                        onChange={(e) => setFeedInput(item.id, e.target.value)}
                                                        onKeyDown={(e) => e.key === 'Enter' && submitFeedComment(item.username, item.id)}
                                                        className="flex-1 bg-gray-100 dark:bg-gray-600 rounded-full px-3 py-1.5 text-[10px] outline-none dark:text-white"
                                                    />
                                                    <button onClick={() => submitFeedComment(item.username, item.id)} className="text-indigo-600 p-1.5">
                                                        <Icon name="send" className="w-4 h-4"/>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}
                    
                    {currentChatFriend && <ChatModal myUsername={myUsername} friendUsername={currentChatFriend} onClose={() => setCurrentChatFriend(null)} sendNotif={sendNotification} />}
                    {isMessagesOpen && <MessagesModal myUsername={myUsername} friends={friends} onClose={() => setIsMessagesOpen(false)} onChatOpen={(friend) => { setIsMessagesOpen(false); setCurrentChatFriend(friend); }} />}
                    {isStatsOpen && <StatsModal markers={markers} onClose={() => setIsStatsOpen(false)} />}
                    {isLeaderboardOpen && <LeaderboardModal appId={appId} myUsername={myUsername} friends={friends} onClose={() => setIsLeaderboardOpen(false)} />}
                    {isCinemaOpen && <CinemaModal markers={markers} onClose={() => setIsCinemaOpen(false)} />}
                    {isSettingsOpen && <SettingsModal myUsername={myUsername} onClose={()=>setIsSettingsOpen(false)} onLogout={onLogout} darkMode={darkMode} toggleDarkMode={toggleDarkMode} showCityNames={showCityNames} setShowCityNames={setShowCityNames} onOpenStats={() => setIsStatsOpen(true)} />}

                    <div id="map-container" className="flex-1 z-0 relative bg-slate-100">{loading && <div className="absolute inset-0 flex items-center justify-center bg-white/80 z-[999] backdrop-blur-sm"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-red-600 mr-2"></div></div>}</div>
                    
                    {zoomedImage && <div className="fixed inset-0 z-[2000] bg-black/95 flex items-center justify-center p-4" onClick={() => setZoomedImage(null)}>
                        <button className="absolute left-4 top-1/2 text-white bg-white/10 p-3 rounded-full" onClick={prevLightbox}><Icon name="chevron-left" className="w-8 h-8"/></button>
                        <img src={zoomedImage} className="max-h-[90vh] max-w-[90vw] rounded-lg shadow-2xl animate-fadeIn object-contain" onClick={(e)=>e.stopPropagation()}/>
                        <button className="absolute right-4 top-1/2 text-white bg-white/10 p-3 rounded-full" onClick={nextLightbox}><Icon name="chevron-right" className="w-8 h-8"/></button>
                        <button className="absolute top-4 right-4 text-white bg-white/10 p-3 rounded-full" onClick={() => setZoomedImage(null)}><Icon name="x" className="w-6 h-6"/></button>
                        <div className="absolute bottom-4 left-1/2 -translate-x-1/2 bg-black/50 text-white px-4 py-1 rounded-full text-sm font-mono backdrop-blur-md">
                            {currentImageIndex + 1} / {lightboxImages.length}
                        </div>
                    </div>}
                    
                    {isNotifOpen && <NotificationModal notifications={notifications} onClose={()=>setIsNotifOpen(false)} onAccept={handleAcceptNotif} onReject={handleRejectNotif}/>}
                    {isPartnerModalOpen && <PartnerModal myUsername={myUsername} currentPartner={partner} onClose={() => setIsPartnerModalOpen(false)} onLink={linkPartner} onBreakUp={breakUpPartner}/>}
                    
                    {isModalOpen && (
                        <div className="fixed inset-0 z-[1000] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm animate-fadeIn">
                            <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col overflow-hidden">
                                <div className={`${activeTab === 'couple' ? 'bg-pink-500' : 'bg-red-600'} p-5 text-white flex justify-between items-center shadow-lg shrink-0`}>
                                    <span className="font-black text-xl flex gap-2 items-center tracking-wide"><Icon name="map-pin" className="w-6 h-6"/> {selectedCity?.name}</span>
                                    <button onClick={()=>setIsModalOpen(false)} className="hover:bg-white/20 p-1.5 rounded-full transition-colors"><Icon name="x" className="w-6 h-6"/></button>
                                </div>
                                <div className="p-6 overflow-y-auto flex-1 custom-scrollbar">
                                    {!isReadOnly && (
                                        <div className="flex gap-4 mb-6">
                                            <select value={status} onChange={(e) => setStatus(e.target.value)} className="flex-1 border dark:border-gray-600 rounded-xl p-3 text-sm bg-gray-50 dark:bg-gray-700 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                                                <option value="visited">✅ Gezildi</option>
                                                <option value="bucket">🎯 Gideceğim</option>
                                            </select>
                                            <select value={category} onChange={(e) => setCategory(e.target.value)} className="flex-1 border dark:border-gray-600 rounded-xl p-3 text-sm bg-gray-50 dark:bg-gray-700 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                                                {categories.filter(c => c !== "Deniz" || (selectedCity && coastalCities.includes(selectedCity.name))).map(c => <option key={c} value={c}>{c}</option>)}
                                            </select>
                                        </div>
                                    )}
                                    
                                    {(status === 'visited' || status === 'bucket') && (
                                        <div className="bg-orange-50 dark:bg-orange-900/20 border border-orange-100 dark:border-orange-800/50 p-4 rounded-xl mb-6 shadow-sm">
                                            <h4 className="text-sm font-bold text-orange-800 dark:text-orange-300 mb-3 flex gap-2 items-center"><Icon name="compass" className="w-4 h-4"/> Öneriler</h4>
                                            <div className="space-y-2">{((citySuggestionsData[selectedCity?.name] && citySuggestionsData[selectedCity?.name][category]) || citySuggestionsData[selectedCity?.name]?.["Genel"] || ["Gezilecek Yer 1", "Gezilecek Yer 2", "Gezilecek Yer 3", "Gezilecek Yer 4"]).slice(0, 4).map((place, idx) => { 
                                                const isChecked = checkedPlaces.includes(place); 
                                                const isBucket = status === 'bucket';
                                                return (
                                                    <div key={idx} onClick={()=> !isBucket && toggleCheckedPlace(place)} className={`flex items-center gap-3 p-3 rounded-lg border transition-all ${!isBucket ? 'cursor-pointer' : ''} ${isChecked ? 'bg-green-50 border-green-200' : 'bg-white dark:bg-gray-700 border-gray-100 dark:border-gray-600'}`}>
                                                        <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center ${isChecked ? 'bg-green-500 border-green-500' : 'bg-white border-gray-300'} ${isBucket ? 'opacity-50' : ''}`}>
                                                            {isChecked && <Icon name="check" className="w-3 h-3 text-white"/>}
                                                        </div>
                                                        <span className={`text-sm ${isChecked ? 'text-green-800 dark:text-green-300 font-bold' : 'text-gray-700 dark:text-gray-300'}`}>{place}</span>
                                                    </div>
                                                ); 
                                            })}</div>
                                        </div>
                                    )}

                                    {status === 'visited' && (
                                        <div className="mb-6 flex flex-col gap-4 items-center bg-gray-50 dark:bg-gray-700/50 p-4 rounded-xl border border-gray-100 dark:border-gray-600 shadow-inner">
                                            <div className="text-center">
                                                <span className="text-[10px] font-bold text-gray-400 uppercase block mb-1">Senin Puanın</span>
                                                <StarRating rating={rating} setRating={isReadOnly ? () => {} : setRating} readOnly={isReadOnly} size="w-8 h-8" />
                                            </div>
                                            
                                            <div className="w-full h-px bg-gray-200 dark:bg-gray-600"></div>
                                            
                                            <div className="flex items-center justify-between w-full px-4">
                                                <span className="text-xs font-bold text-gray-500">Şehir Ortalaması</span>
                                                <div className="flex items-center gap-1">
                                                    <Icon name="star" className="w-4 h-4 text-yellow-400 fill-yellow-400"/>
                                                    <span className="text-sm font-black text-gray-800 dark:text-white">{cityStats.avg || "0"}</span>
                                                    <span className="text-[10px] text-gray-400 font-bold">({cityStats.count || 0} oy)</span>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    
                                    <div className="mb-6">
                                        <div className="font-bold text-sm mb-3 dark:text-white flex items-center gap-2 uppercase tracking-wide"><Icon name="image" className="w-4 h-4"/> Fotoğraflar</div>
                                        <div className="grid grid-cols-4 gap-2 mb-3">
                                            {images.map((img,i) => (
                                                <div key={i} className="relative aspect-square rounded-lg overflow-hidden group border border-gray-100 shadow-sm">
                                                    <img src={img} className="w-full h-full object-cover cursor-zoom-in" onClick={() => openLightbox(img, images)}/>
                                                    {!isReadOnly && <button onClick={()=>setImages(images.filter((_,x)=>x!==i))} className="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="x" className="w-3 h-3"/></button>}
                                                </div>
                                            ))}
                                            {!isReadOnly && <label className="aspect-square border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer flex items-center justify-center text-gray-400 hover:border-blue-500 hover:text-blue-500 transition-all shadow-sm"><Icon name="plus" className="w-6 h-6"/><input type="file" multiple className="hidden" onChange={handleImage}/></label>}
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                        {/* ANI KISMI (HERKESE AÇIK) */}
                                        <div>
                                            <label className="font-bold text-sm dark:text-white flex items-center gap-2 uppercase tracking-wide mb-2"><Icon name="book-open" className="w-4 h-4"/> Anı (Herkese Açık)</label>
                                            {!isReadOnly ? (
                                                <textarea className="w-full border border-gray-200 dark:border-gray-600 rounded-xl p-4 text-sm focus:ring-2 focus:ring-blue-500 outline-none dark:bg-gray-700 dark:text-white shadow-inner min-h-[150px]" rows="6" value={memory} onChange={e=>setMemory(e.target.value)} placeholder="Bu şehirle ilgili anılarını paylaş..."></textarea>
                                            ) : (
                                                <div className="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-xl text-sm text-gray-700 dark:text-gray-300 min-h-[100px] border border-gray-100 dark:border-gray-600 italic">
                                                    {memory || "Henüz bir anı paylaşılmamış."}
                                                </div>
                                            )}
                                        </div>

                                        {/* GÜNLÜK KISMI (SADECE SAHİBİ GÖRÜR) */}
                                        {!isReadOnly && (
                                            <div>
                                                <div className="flex justify-between mb-2 items-center">
                                                    <label className="font-bold text-sm dark:text-white flex items-center gap-2 uppercase tracking-wide"><Icon name="lock" className="w-4 h-4"/> Günlük (Gizli)</label>
                                                    <button onClick={enhanceNote} disabled={isEnhancingNote || !note} className="text-[10px] text-purple-600 font-bold bg-purple-50 px-2 py-1 rounded-full border border-purple-100 hover:bg-purple-100 transition-all">{isEnhancingNote ? 'Yazılıyor...' : 'AI ile Düzenle'}</button>
                                                </div>
                                                <textarea className="w-full border border-gray-200 dark:border-gray-600 rounded-xl p-4 text-sm focus:ring-2 focus:ring-red-500 outline-none dark:bg-gray-700 dark:text-white shadow-inner min-h-[150px]" rows="6" value={note} onChange={e=>setNote(e.target.value)} placeholder="Günlüğüne yaz... Bu yazıyı sadece sen görebilirsin."></textarea>
                                            </div>
                                        )}
                                    </div>

                                    <div className="mt-6 pt-5 border-t dark:border-gray-700">
                                        <h4 className="font-bold text-sm mb-3 dark:text-white flex gap-2 uppercase tracking-wide"><Icon name="message-square" className="w-4 h-4"/> Yorumlar</h4>
                                        <div className="space-y-4 mb-5 max-h-64 overflow-y-auto custom-scrollbar pr-1">
                                            {comments.map(c => (
                                                <div key={c.id} className="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-xl text-sm border dark:border-gray-600 shadow-sm">
                                                    <div className="flex justify-between items-start mb-1">
                                                        <span onClick={() => handleUserNavigation(c.user)} className="font-bold text-xs text-gray-800 dark:text-white cursor-pointer hover:underline">@{c.user}</span>
                                                        <span className="text-[10px] text-gray-400">{c.date}</span>
                                                    </div>
                                                    <p className="text-gray-600 dark:text-gray-300 text-xs leading-relaxed mb-2">{renderClickableNote(c.text)}</p>
                                                    
                                                    {/* YORUM AKSİYONLARI */}
                                                    <div className="flex items-center gap-3">
                                                        <button onClick={() => toggleCommentLike(c.id)} className={`flex items-center gap-1 text-[10px] font-bold transition-colors ${c.likes?.includes(myUsername) ? 'text-red-500' : 'text-gray-400 hover:text-red-400'}`}>
                                                            <Icon name="heart" className={`w-3.5 h-3.5 ${c.likes?.includes(myUsername) ? 'fill-current' : ''}`} />
                                                            {c.likes?.length || 0}
                                                        </button>
                                                        <button onClick={() => setActiveReplyId(activeReplyId === c.id ? null : c.id)} className="flex items-center gap-1 text-[10px] font-bold text-gray-400 hover:text-indigo-500 transition-colors">
                                                            <Icon name="message-circle" className="w-3.5 h-3.5" /> Yanıtla
                                                        </button>
                                                    </div>

                                                    {/* YANIT GİRİŞ ALANI */}
                                                    {activeReplyId === c.id && (
                                                        <div className="mt-2 flex gap-2 animate-fadeIn">
                                                            <input 
                                                                type="text" 
                                                                value={replyText} 
                                                                onChange={e=>setReplyText(e.target.value)} 
                                                                placeholder="Yanıtın..." 
                                                                className="flex-1 border border-gray-200 dark:border-gray-600 rounded-full px-3 py-1.5 text-xs outline-none dark:bg-gray-800 dark:text-white focus:border-indigo-500"
                                                                autoFocus
                                                            />
                                                            <button onClick={() => submitReply(c.id)} className="bg-indigo-600 text-white p-1.5 rounded-full hover:bg-indigo-700 transition-all">
                                                                <Icon name="send" className="w-3 h-3"/>
                                                            </button>
                                                        </div>
                                                    )}

                                                    {/* İÇ İÇE YANITLAR */}
                                                    {c.replies && c.replies.length > 0 && (
                                                        <div className="mt-2 pl-3 border-l-2 border-gray-200 dark:border-gray-600 space-y-2">
                                                            {c.replies.map(r => (
                                                                <div key={r.id} className="text-xs">
                                                                    <div className="flex items-center gap-1 mb-0.5">
                                                                        <span onClick={() => handleUserNavigation(r.user)} className="font-bold text-indigo-600 cursor-pointer hover:underline">@{r.user}</span>
                                                                        <span className="text-[9px] text-gray-400">{r.date}</span>
                                                                    </div>
                                                                    <p className="text-gray-600 dark:text-gray-300">{renderClickableNote(r.text)}</p>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                        <div className="flex gap-2"><input type="text" value={newComment} onChange={e=>setNewComment(e.target.value)} placeholder="Yorum bırak..." className="flex-1 border border-gray-200 dark:border-gray-600 rounded-full px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none dark:bg-gray-700 dark:text-white shadow-sm"/><button onClick={handleAddComment} className="bg-blue-600 text-white p-2 rounded-full hover:bg-blue-700 transition-all shadow-md"><Icon name="send" className="w-4 h-4"/></button></div>
                                    </div>
                                </div>
                                <div className="p-4 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-800 flex justify-between items-center shrink-0">
                                    {!isReadOnly && markers.some(m => m.cityName === selectedCity?.name) ? (
                                        <button onClick={() => handleDelete(selectedCity.name)} className="px-4 py-2 text-red-600 text-xs font-bold hover:bg-red-50 rounded-xl transition-colors flex items-center gap-1 border border-red-100">
                                            <Icon name="trash-2" className="w-4 h-4"/> Sıfırla
                                        </button>
                                    ) : <div></div>}
                                    <div className="flex gap-3">
                                        <button onClick={()=>setIsModalOpen(false)} className="px-5 py-2.5 bg-white border border-gray-200 dark:bg-gray-700 dark:border-gray-600 rounded-xl text-gray-600 dark:text-gray-300 text-sm font-bold shadow-sm">İptal</button>
                                        {!isReadOnly && <button onClick={handleSave} className={`px-8 py-2.5 text-white rounded-xl text-sm font-bold shadow-md transform transition-all active:scale-95 ${activeTab === 'couple' ? 'bg-pink-600 hover:bg-pink-700' : 'bg-red-600 hover:bg-red-700'}`}>Kaydet</button>}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const Root = () => {
            const [user, setUser] = useState(null);
            const [myUsername, setMyUsername] = useState(localStorage.getItem('my_username'));
            const [viewUser, setViewUser] = useState(null);

            useEffect(() => {
                if(!isFirebaseReady) return;
                const unsub = auth.onAuthStateChanged(u => { if(u) setUser(u); else auth.signInAnonymously(); });
                return () => unsub();
            }, []);

            if (!isFirebaseReady) return <div className="h-screen flex items-center justify-center text-red-600">Firebase Config Eksik!</div>;
            if (!user) return <div className="h-screen flex items-center justify-center text-red-600 font-bold bg-gray-50"><div className="animate-spin rounded-full h-8 w-8 border-b-2 border-red-600 mr-2"></div> Harita Yükleniyor...</div>;
            if (!myUsername) return <LoginScreen onLogin={(u) => { setMyUsername(u); localStorage.setItem('my_username', u); }} />;
            return <MainApp user={user} myUsername={myUsername} currentUsername={viewUser || myUsername} onViewChange={setViewUser} onLogout={()=>{ localStorage.removeItem('my_username'); setMyUsername(null); setViewUser(null); }} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Root />);
    </script>
</body>
</html>
